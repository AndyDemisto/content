commonfields:
  id: Symantec MSS
  version: -1
name: Symantec MSS
display: Symantec MSS
category: Analytics & SIEM
detaileddescription: Encode the .p12 certificate file using any File to Base64 Encoder
  and paste the encoded string in the "Certificate" field
configuration:
- display: Server URL
  name: server
  defaultvalue: https://api.monitoredsecurity.com
  type: 0
  required: true
- display: Certificate (Base64 encoded)
  name: certificate
  defaultvalue: ""
  type: 12
  required: true
- display: Certificate Passphrase
  name: passphrase
  defaultvalue: ""
  type: 4
  required: false
- display: Do not validate server certificate (insecure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
- display: Fetch incidents
  name: isFetch
  defaultvalue: ""
  type: 8
  required: false
- display: Incident type
  name: incidentType
  defaultvalue: ""
  type: 13
  required: false
- display: Timezone of the server in minutes. e.g. for gmt +3 set +180 (set only if
    different than Demisto server), relevant for fetch notable events only
  name: timezone
  defaultvalue: ""
  type: 0
  required: false
script:
  script: |
    import tempfile
    import ssl
    import OpenSSL.crypto
    import requests
    import contextlib
    import xml.etree.ElementTree
    import base64
    import re
    import datetime
    import xmltodict

    # CONSTANTS
    SECURITY_INCIDENT_SUMMARY_NODE_XPATH = './/SecurityIncidentSummary'
    SECURITY_INCIDENT_NODE_XPATH = './/SecurityIncident'

    # GLOBALS
    SERVER_URL = re.sub('/[\/]+$/', '', demisto.params()["server"])
    CERTIFICATE = base64.b64decode(demisto.params()["certificate"])
    CERTIFICATE_PASSPHRASE = demisto.params()["passphrase"]
    VERIFY =  demisto.params()['insecure'] == False

    # HELPERS
    @contextlib.contextmanager
    def pfx_to_pem(pfx, pfx_password):
        ''' Decrypts the .pfx file to be used with requests. '''
        with tempfile.NamedTemporaryFile(suffix='.pem') as t_pem:
            f_pem = open(t_pem.name, 'wb')
            p12 = OpenSSL.crypto.load_pkcs12(pfx, pfx_password)
            f_pem.write(OpenSSL.crypto.dump_privatekey(OpenSSL.crypto.FILETYPE_PEM, p12.get_privatekey()))
            f_pem.write(OpenSSL.crypto.dump_certificate(OpenSSL.crypto.FILETYPE_PEM, p12.get_certificate()))
            ca = p12.get_ca_certificates()
            if ca is not None:
                for cert in ca:
                    f_pem.write(OpenSSL.crypto.dump_certificate(OpenSSL.crypto.FILETYPE_PEM, cert))
            f_pem.close()
            yield t_pem.name

    def apiCall(body, headers):
        with pfx_to_pem(CERTIFICATE, CERTIFICATE_PASSPHRASE) as cert:
            res = requests.post(url=SERVER_URL + '/SWS/incidents.asmx', cert=cert, data=body, headers=headers, verify=VERIFY)
            if res.status_code < 200 or res.status_code >= 300:
                raise Exception('Got status code ' + str(res.status_code) + ' with body ' + res.content + ' with headers ' + str(res.headers))
            return xml.etree.ElementTree.fromstring(res.content)

    def event_to_incident(event):
        incident = {}
        incident["name"] = "Incident: %s (%s)" % (event['IncidentNumber'], event['Classification'])
        incident["details"] = event["Description"]
        incident["occurred"] = event["TimeCreated"]
        incident["rawJSON"] = json.dumps(event)

        labels = []
        incident['labels'] = labels

        return incident

    # FUNCTIONS
    def fetchIncidents():
        lastRun = demisto.getLastRun() and demisto.getLastRun()['time']

        incidents = []
        t = datetime.datetime.utcnow()
        if demisto.get(demisto.params(), 'timezone'):
            timezone = demisto.params()['timezone']
            t = t + timedelta(minutes=int(timezone))
        now = t.strftime("%Y-%m-%dT%H:%M:%S")

        if len(lastRun) == 0:
            t = t - timedelta(minutes=10)
            lastRun = t.strftime("%Y-%m-%dT%H:%M:%S")

        events = getRecentList(lastRun)
        for event in events:
            inc = event_to_incident(event)
            incidents.append(inc)

        demisto.incidents(incidents)
        demisto.setLastRun({'time': now})

    def getRecentList(time):
        result = []

        # Request recent events
        root = getRecentListRequest(time)
        incidentNodes = root.findall(SECURITY_INCIDENT_SUMMARY_NODE_XPATH)

        for incident in incidentNodes:
            element = {}
            stringIncident = xml.etree.ElementTree.tostring(incident)
            dictIncident = xmltodict.parse(stringIncident)['SecurityIncidentSummary']

            # For each recent event - query for additional details
            dictQuery = queryIncident(dictIncident['IncidentNumber'])

            # Merge both dicts
            element.update(dictIncident)
            element.update(dictQuery)
            result.append(element)

            ### CONSIDER SLEEPING HERE IN CASE WE GET BLOCKED BY THE SERVER

        return result

    def updateIncident():
        # Fill in required fields from the existing incident (for the api call)
        num = demisto.args()['number']  # requried by demisto
        dictQuery = queryIncident(num=num, workflowQuery=True)
        dictWorkflowQuery = dictQuery['WorkFlowDetail']

        status = demisto.args()['status'] if 'status' in demisto.args() else dictWorkflowQuery['Status'] if dictWorkflowQuery['Status'] else 'Closed' # required by api
        resolution = demisto.args()['resolution'] if 'resolution' in demisto.args() else dictWorkflowQuery['Resolution'] if dictWorkflowQuery['Resolution'] else 'Resolved'  # required by api
        severity = demisto.args()['severity'] if 'severity' in demisto.args() else dictQuery['Severity'] if dictQuery['Severity'] else '' # required by api

        ref = demisto.args()['reference'] if 'reference' in demisto.args() else None # optional
        comments = demisto.args()['comments'] if 'comments' in demisto.args() else None # optional

        # Only one of them should exist
        assignToOrg = demisto.args()['assignOrganization'] if 'assignOrganization' in demisto.args() else None
        assignToPerson = demisto.args()['assignPerson'] if 'assignPerson' in demisto.args() else None

        if assignToOrg and assignToPerson:
            raise Exception('Unable to assign to both organization and a person, please choose only one')

        if not assignToOrg and not assignToPerson:
            if 'AssignedOrganization' in dictWorkflowQuery and dictWorkflowQuery['AssignedOrganization']:
                assignToOrg = dictWorkflowQuery['AssignedOrganization']
            elif 'AssignedPerson' in dictWorkflowQuery and dictWorkflowQuery['AssignedPerson']:
                assignToPerson = dictWorkflowQuery['AssignedPerson']

        res = updateIncidentRequest(num, status, resolution, ref, severity, assignToOrg, assignToPerson, comments)
        demisto.results(res)

    def queryIncident(num, workflowQuery=False):
        query = queryIncidentRequest(num) if not workflowQuery else queryIncidentWorkflowRequest(num)
        queryNode = query.find(SECURITY_INCIDENT_NODE_XPATH)
        stringQuery = xml.etree.ElementTree.tostring(queryNode)
        dictQuery = xmltodict.parse(stringQuery)['SecurityIncident']
        return dictQuery

    def queryIncidentWorkflowRequest(num):
        body = """<?xml version="1.0" encoding="utf-8"?>
                    <soap12:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap12="http://www.w3.org/2003/05/soap-envelope">
                        <soap12:Body>
                            <IncidentWorkflowQuery xmlns="https://www.monitoredsecurity.com/">
                                <IncidentNumber>%s</IncidentNumber>
                            </IncidentWorkflowQuery>
                        </soap12:Body>
                    </soap12:Envelope>""" % (num)
        headers = {
            'content-Type': 'application/soap+xml; charset=utf-8',
            'content-Length': str(len(body))
        }
        return apiCall(body=body, headers=headers)

    def queryIncidentRequest(num):
        body = """<?xml version="1.0" encoding="utf-8"?>
                    <soap12:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap12="http://www.w3.org/2003/05/soap-envelope">
                        <soap12:Body>
                            <IncidentQuery xmlns="https://www.monitoredsecurity.com/">
                                <IncidentNumber>%s</IncidentNumber>
                            </IncidentQuery>
                        </soap12:Body>
                    </soap12:Envelope>""" % (num)
        headers = {
            'content-Type': 'application/soap+xml; charset=utf-8',
            'content-Length': str(len(body))
        }
        return apiCall(body=body, headers=headers)

    def getRecentListRequest(time):
        body = """<?xml version="1.0" encoding="utf-8"?>
                    <soap12:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap12="http://www.w3.org/2003/05/soap-envelope">
                      <soap12:Body>
                        <IncidentGetRecentList xmlns="https://www.monitoredsecurity.com/">
                            <StartTimeStampGMT>%s</StartTimeStampGMT>
                        </IncidentGetRecentList>
                      </soap12:Body>
                    </soap12:Envelope>""" % (time)
        headers = {
            'content-Type': 'application/soap+xml; charset=utf-8',
            'content-Length': str(len(body))
        }
        return apiCall(body=body, headers=headers)

    def updateIncidentRequest(num, status, resolution, ref, severity, assignToOrg, assignToPerson, comments):
        # Create optional parameter tags if needed
        ref = "<Reference>%s</Reference>" % (ref) if ref else ""
        assignToOrg = "<AssignedToOrganiztion>%s</AssignedToOrganiztion>" % (assignToOrg) if assignToOrg else ""
        assignToPerson = "<AssignedToPerson>%s</AssignedToPerson>" % (assignToPerson) if assignToPerson else ""
        comments = "<Comments>%s</Comments>" % (comments) if comments else ""

        body = """<?xml version="1.0" encoding="utf-8"?>
                    <soap12:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap12="http://www.w3.org/2003/05/soap-envelope">
                      <soap12:Body>
                        <UpdateIncidentWorkflow xmlns="https://www.monitoredsecurity.com/">
                          <IncidentNumber>%s</IncidentNumber>
                          <Status>%s</Status>
                          <Resolution>%s</Resolution>
                          %s
                          <Severity>%s</Severity>
                          %s
                          %s
                          %s
                        </UpdateIncidentWorkflow>
                      </soap12:Body>
                    </soap12:Envelope>""" % (num, status, resolution, ref, severity, assignToOrg, assignToPerson, comments)
        headers = {
            'content-Type': 'application/soap+xml; charset=utf-8',
            'content-Length': str(len(body))
        }
        return apiCall(body=body, headers=headers)


    # EXECUTION
    if demisto.command() == 'fetch-incidents' or demisto.command() == 'smss-remove-later': # remove the 2nd condition
        fetchIncidents()
        exit(0)

    if demisto.command() == 'smss-update-incident-workflow':
        updateIncident()
        exit(0)
  type: python
  commands:
  - name: smss-update-incident-workflow
    arguments:
    - name: number
      required: true
      default: true
      description: The incident number in the SOC
    - name: status
      description: To change the incident status
    - name: resolution
      description: To change he incident status resolution
    - name: reference
      description: Update reference comments
    - name: severity
      description: To change the incident severity
    - name: assignOrganization
      description: 'To change incident assignment to organization (Note: assign to
        an organization OR a person is required)'
    - name: assignPerson
      description: 'To change incident assignment to person. (Note: assign to an organization
        OR a person is required)'
    - name: comments
      description: Incident update comment
    description: Updates an incident's workflow by incident number
  - name: smss-remove-later
    arguments: []
  dockerimage: demisto/symantec_mss
  isfetch: true
