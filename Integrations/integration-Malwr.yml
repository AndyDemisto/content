versionedfields: {}
commonfields:
  id: malwr
  version: -1
name: malwr
display: malwr
category: Forensics & Malware Analysis
image: data:image/png;base64,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
description: Analyze files using the malwr sandbox
configuration:
- display: URL
  name: server
  defaultvalue: https://malwr.com
  type: 0
  required: true
- display: Credentials
  name: credentials
  defaultvalue: ""
  type: 9
  required: true
script:
  script: |
    import hashlib
    import re
    import requests
    import os
    from bs4 import BeautifulSoup

    # The Malwar API from https://github.com/PaulSec/API-malwr.com

    class MalwrAPI(object):
        """
            MalwrAPI Main Handler
        """
        session = None
        logged = False
        verbose = False
        headers = {
            'User-Agent': "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:41.0) " +
                          "Gecko/20100101 Firefox/41.0"
        }

        def __init__(self, url, verbose=False, username=None, password=None, apikey=None):
            self.url = url
            self.verbose = verbose
            self.session = requests.session()
            self.username = username
            self.password = password
            self.apikey = apikey

        def login(self):
            """Login on malwr.com website"""

            demisto.info('login...')

            if self.username and self.password:
                soup = self.request_to_soup(self.url + '/account/login')
                csrf_input = soup.find(attrs=dict(name='csrfmiddlewaretoken'))
                csrf_token = csrf_input['value']
                payload = {
                    'csrfmiddlewaretoken': csrf_token,
                    'username': u'{0}'.format(self.username),
                    'password': u'{0}'.format(self.password)
                }
                login_request = self.session.post(self.url + "/account/login/",
                                                  data=payload, headers=self.headers)

                if login_request.status_code == 200:
                    demisto.info('Login OK')
                    self.logged = True
                    return True
                else:
                    demisto.info('Login failed')
                    self.logged = False
                    return False

        def request_to_soup(self, url=None):
            """Request url and return the Beautifoul Soup object of html returned"""
            if not url:
                url = self.url

            req = self.session.get(url, headers=self.headers)
            soup = BeautifulSoup(req.content, "html.parser")
            return soup

        def display_message(self, s):
            """Display the message"""
            if self.verbose:
                print '[verbose] %s' % s

        def get_latest_comments(self):
            """Request the last comments on malwr.com"""
            res = []
            soup = self.request_to_soup()
            comments = soup.findAll('div', {'class': 'span6'})[3]

            for comment in comments.findAll('tr'):
                infos = comment.findAll('td')

                infos_to_add = {
                    'comment': infos[0].string,
                    'comment_url': infos[1].find('a')['href']
                }
                res.append(infos_to_add)

            return res

        def get_recent_domains(self):
            """Get recent domains on index page
            Returns a list of objects with keys domain_name and url_analysis"""
            res = []
            soup = self.request_to_soup()

            domains = soup.findAll('div', {'class': 'span6'})[1]
            for domain in domains.findAll('tr'):
                infos = domain.findAll('td')
                infos_to_add = {
                    'domain_name': infos[0].find('span').string,
                    'url_analysis': infos[1].find('a')['href']
                }
                res.append(infos_to_add)

            return res

        def get_public_tags(self):
            """Get public tags on index page
            Return a tag list"""
            res = []
            soup = self.request_to_soup()

            tags = soup.findAll('div', {'class': 'span6'})[2]
            for tag in tags.findAll('a', {'class': 'tag-label'}):
                res.append(tag.string)

            return res

        def get_recent_analyses(self):

            res = []
            soup = self.request_to_soup()

            submissions = soup.findAll('div', {'class': 'span6'})[0]
            for submission in submissions.findAll('tr'):
                infos = submission.findAll('td')

                infos_to_add = {
                    'submission_time': infos[0].string,
                    'hash': infos[1].find('a').string,
                    'submission_url': infos[1].find('a')['href']
                }
                res.append(infos_to_add)

            return res

        def submit_folder(self, path, analyze=True, share=True, private=True):
            filelist = [f for f in os.listdir(path)]
            res = []
            for item in filelist:
                res.append(self.submit_sample(path + item, analyze, share, private))
            return res

        def submit_sample(self, filepath, analyze=True, share=True, private=True):
            demisto.info('submit_sample, filepath: %s' % (filepath, ))
            # demisto.info(fileResult())
            filepath = demisto.executeCommand('getFilePath', {'id': demisto.args()['fileId']})

            if self.logged is False:
                demisto.info('login is required, performing...')
                self.login()

            s = self.session
            req = s.get(self.url + '/submission/', headers=self.headers)

            demisto.info('req = %s' % (req, ))

            soup = BeautifulSoup(req.content, "html.parser")

            # TODO: math_captcha_question might be unused. Remove.
            # math_captcha_question = soup.find('input', {'name': 'math_captcha_question'})['value']

            pattern = '(\d [-+*] \d) ='
            data = {
                'math_captcha_field': eval(re.findall(pattern, req.content)[0]),
                'math_captcha_question': soup.find('input', {'name': 'math_captcha_question'})['value'],
                'csrfmiddlewaretoken': soup.find('input', {'name': 'csrfmiddlewaretoken'})['value'],
                'share': 'on' if share else 'off',  # share by default
                'analyze': 'on' if analyze else 'off',  # analyze by default
                'private': 'on' if private else 'off'  # private by default
            }

            req = s.post(self.url + '/submission/', data=data, headers=self.headers,
                         files={'sample': open(filepath, 'rb')})

            # TODO: soup might be unused. Remove.
            # soup = BeautifulSoup(req.content, "html.parser")

            # regex to check if the file was already submitted before
            pattern = '(\/analysis\/[a-zA-Z0-9]{12,}\/)'
            submission_links = re.findall(pattern, req.content)

            res = {
                'md5': hashlib.md5(open(filepath, 'rb').read()).hexdigest(),
                'file': filepath
            }

            if len(submission_links) > 0:
                self.display_message('File %s was already submitted, taking last analysis' % filepath)
                res['analysis_link'] = submission_links[0]
            else:
                pattern = '(\/submission\/status\/[a-zA-Z0-9]{12,}\/)'
                submission_status = re.findall(pattern, req.content)

                if len(submission_status) > 0:
                    res['analysis_link'] = submission_status[0]
                elif 'file like this waiting for processing, submission aborted.' in req.content:
                    self.display_message('File already submitted, check on the site')

                    return None
                else:
                    self.display_message('Error with the file %s' % filepath)

                    return None

            return res

        def search(self, search_word):
            # Do nothing if not logged in
            if not self.logged:
                res = self.login()
                if res is False:
                    return False

            search_url = self.url + '/analysis/search/'
            c = self.request_to_soup(search_url)

            csrf_input = c.find(attrs=dict(name='csrfmiddlewaretoken'))
            csrf_token = csrf_input['value']
            payload = {
                'csrfmiddlewaretoken': csrf_token,
                'search': u'{}'.format(search_word)
            }
            sc = self.session.post(search_url, data=payload, headers=self.headers)
            ssc = BeautifulSoup(sc.content, "html.parser")

            res = []
            error = ssc.findAll('div', {'class': 'alert-error'})
            if len(error) > 0:
                self.display_message('Invalid search term')
                return []
            submissions = ssc.findAll('div', {'class': 'box-content'})[0]
            sub = submissions.findAll('tbody')[0]
            for submission in sub.findAll('tr'):
                infos = submission.findAll('td')
                infos_to_add = {
                    'submission_time': infos[0].string,
                    'hash': infos[1].find('a').string,
                    'submission_url': infos[1].find('a')['href'],
                    'file_name': infos[2].string
                }
                res.append(infos_to_add)

            return res

        def getReport(self, search_url):
            # Do nothing if not logged in
            if not self.logged:
                res = self.login()
                if res is False:
                    return False

            search_url = self.url + search_url
            c = self.request_to_soup(search_url)

            csrf_input = c.find(attrs=dict(name='csrfmiddlewaretoken'))
            csrf_token = csrf_input['value']
            payload = {
                'csrfmiddlewaretoken': csrf_token,
            }
            sc = self.session.post(search_url, data=payload, headers=self.headers)
            ssc = BeautifulSoup(sc.content, "html.parser")

            output = {"IP": [], "Domain": []}

            domains = ssc.find(id="domains").find_all("td")
            # Will go domain, IP, domain, IP
            for i in range(len(domains)):
                if i%2 == 0:
                    # Domain
                    output["Domain"].append(domains[i].text)
                else:
                    # IP
                    output["IP"].append(domains[i].text)

            ips = ssc.find(id="hosts").find_all("td")
            output["IP"] += [x.text for x in ips]

            return output


    def md5(fname):
        hash_md5 = hashlib.md5()
        with open(fname, "rb") as f:
            for chunk in iter(lambda: f.read(4096), b""):
                hash_md5.update(chunk)

        return hash_md5.hexdigest()


    # try:
    #     api = MalwrAPI(verbose=True, username=demisto.args()['username'], password=demisto.args()['password'])
    # except:
    #     print('Trouble with ~/.malwr config file, authenticated features unavailable')
    #     api = MalwrAPI(verbose=True)

    # if args.search is not None:
    #     if os.path.isfile(args.search):
    #         fhash = md5(args.search)
    #         print('Search for hash %s (file %s)' % (fhash, args.search))
    #         res = api.search(fhash)
    #     else:
    #         print('Search for %s' % args.search)
    #         res = api.search(args.search)
    #     if res is False:
    #         print('failed login')
    #     else:
    #         if res == []:
    #             print('No results')
    #         else:
    #             for d in res:
    #                 print(
    #                     '%s\t%s\t%s\thttps://malwr.com%s' % (
    #                         d['submission_time'], d['file_name'],
    #                         d['hash'], d['submission_url']
    #                     )
    #                 )
    # elif args.submit is not None:
    #     res = api.submit_sample(
    #             filepath=args.submit, share=args.no_share,
    #             private=args.private
    #     )
    #     print('File submitted : https://malwr.com%s for %s (hash: %s)' % (res['analysis_link'], res['file'], res['md5']))
    # elif args.domains:
    #     res = api.get_recent_domains()
    #     print('Recent domains:')
    #     for d in res:
    #         print('%s -> https://malwr.com%s' % (d['domain_name'], d['url_analysis']))
    # elif args.tags:
    #     res = api.get_public_tags()
    #     print('Public tags:')
    #     for t in res:
    #         print(t)
    # elif args.recent:
    #     res = api.get_recent_analyses()
    #     print('Recent analyses:')
    #     for d in res:
    #         print('%s -> https://malwr.com%s' % (d['hash'], d['submission_url']))

    # demisto.info(demisto.args())

    # demisto.log('Test message!!!')

    # def return_message():
    #     return 'message'

    api = MalwrAPI(
        url=demisto.params()['server'],
        verbose=True,
        username=demisto.params()['credentials']['identifier'],
        password=demisto.params()['credentials']['password'],
    )

    if __name__ == '__main__':
        if demisto.command() == 'test-module':
            demisto.results('ok')
            sys.exit(0)

        elif demisto.command() == 'malwr-submit-sample':

            # filepath = demisto.executeCommand('getFilePath', {'id': demisto.args()['fileId']})
            # demisto.info('filepath = %s' % (filepath, ))

            res = api.submit_sample(
                filepath=demisto.args()['fileId']
                # share=args.no_share,
                # private=args.private
            )

            demisto.results(res)

            print 'File submitted : https://malwr.com%s for %s (hash: %s)' % (res['analysis_link'], res['file'], res['md5'])
  type: python
  commands:
  - name: malwr-submit-sample
    arguments:
    - name: fileId
      required: true
      description: The file ID to submit
    description: Submit a sample to be analyzed
hidden: false
