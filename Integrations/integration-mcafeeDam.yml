commonfields:
  id: McafeeDAM
  version: -1
name: McafeeDAM
display: McafeeDAM
category: Authentication
image: data:image/png;base64,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
description: Mcafee Database Activity Monitoring
detaileddescription: Make sure that xmlapi feature is enabled on you Mcafee DAM server,
  and that user has proper permissions to fetch DAM alerts
configuration:
- display: URL
  name: url
  defaultvalue: ""
  type: 0
  required: true
- display: Credentials
  name: credentials
  defaultvalue: ""
  type: 9
  required: true
- display: Batch size for incident fetch
  name: batchSize
  defaultvalue: "10"
  type: 0
  required: false
- display: Fetch incidents
  name: isFetch
  defaultvalue: ""
  type: 8
  required: false
- display: Incident type
  name: incidentType
  defaultvalue: ""
  type: 13
  required: false
- display: Validate ceritifacte
  name: secure
  defaultvalue: "false"
  type: 8
  required: false
- display: Rule Name, If fetch incident is checked, this field must be set and will
    be used to get DAM alerts only from this rule
  name: ruleName
  defaultvalue: ""
  type: 0
  required: false
script:
  script: |2-

    var fixUrl = function(base) {
        res = base;
        if (base && base[base.length - 1] != '/') {
            res = res + '/';
        }
        return res;
    };

    var sendRequest = function(url, service, param) {

        // handle '/' at the end of the url
        if (url[url.length - 1] === '/') {
            url = url.substring(0, url.length - 1);
        }

        // prepare the request url (make sure to encode the query parameter value)
        var requestUrl = url + 'service=' + service;
        if  (param) {
            requestUrl += '&' +  param;
        }
        var res = http(
            requestUrl,
            {
                Method: 'GET', // Can be POST, PUT, DELETE, HEAD, OPTIONS or CONNECT
                Headers: {
                    Accept: ['application/json']
                },
                Username:  params.credentials.identifier,
                Password:  params.credentials.password,

            },
            !params.insecure
        );

        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Request Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }

        return JSON.parse(x2j(res.Body));
    };

    var finalUrl = fixUrl(params.url) + 'xmlapi.svc?';

    var calculateNewLastRun = function(alerts) {
        var res = '';
        var lastAlert = null;
        if (alerts && alerts.length && alerts.length > 0) {
            // transalte yyyy-MM-dd HH:mm:ss.S +Z => yyyy-MM-ddTHH:mm:ss.S+Z => time in millis
            lastAlert = alerts[alerts.length -1];
        } else if (alerts){
            //This is a single element
            lastAlert = alerts;
        }
        if (lastAlert) {
            var createDate = lastAlert.createDate;
            var dateTime = createDate.split(' ');
            var goTime = dateTime[0]+'T'+dateTime[1]+dateTime[2];
            //hack needed, becuase platform problems
            res = new Date(Date.parse(goTime)).getTime() + 1;
        }
        return res;
    };

    var alertToIncident = function(alert) {
        labels = [];
        var keys = Object.keys(alert);
        for (j = 0 ; j < keys.length; j++) {
            if (keys[j] === 'accessedObjects') {
                if (alert.accessedObjects.object && alert.accessedObjects.object.length > 0) {
                    for (k = 0; k < alert.accessedObjects.object.length; k++) {
                        labels.push({type: 'accessedObject', value: alert.accessedObjects.object[k].owner + '.' + alert.accessedObjects.object[k].name + '('+ alert.accessedObjects.object[k].type +')'});
                    }
                }
            } else if (keys[j] === 'database') {
                labels.push({type: 'database-host', value: alert.database.host});
                labels.push({type: 'database-ip', value: alert.database.ip});
                labels.push({type: 'database-id', value: alert.database.id});
                labels.push({type: 'database-name', value: alert.database.name});
            } else if (keys[j] === 'identifyingSensor') {
                labels.push({type: 'sensor-host', value: alert.identifyingSensor.host});
                labels.push({type: 'sensor-ip', value: alert.identifyingSensor.ip});
                labels.push({type: 'sensor-id', value: alert.identifyingSensor.id});
                labels.push({type: 'sensor-name', value: alert.identifyingSensor.name});
                labels.push({type: 'sensor-version', value: alert.identifyingSensor.version});
            } else if (keys[j] === 'rules') {
                if (alert.rules.length > 0) {
                    for (k = 0; k < alert.rules.length; k++) {
                        labels.push({type: 'rule', value: alert.rules[i].name + '('+ alert.rules[i].sysid +')'});
                    }
                } else if (alert.rules) {
                    labels.push({type: 'rule', value: alert.rules.name + '('+ alert.rules.sysid +')'});
                }
            } else {
                labels.push({type: keys[j], value: alert[keys[j]]});
            }
        }
        return {name: 'DAM Event - ' + alert.id, labels: labels, details: alert.operation};
    };

    var alertsToIncident = function(alerts) {
        incidents = [];
        for (i = 0 ; i < alerts.length; i++){
            incident.push(alertToIncident(alerts[i]));
        }
        return incidents;
    };

    var fetchIncidents = function() {
        var count = params.batchSize || 100;
        //Default time back for first fetch is 10 minutes
        var timeBack = 1000 * 60 * 10;
        var urlParams = 'HH$TimeBackPeriod=' + encodeURIComponent(timeBack +'');
        var lastRun = getLastRun();
        if (lastRun && Object.keys(lastRun).length > 0) {
            urlParams = 'HH$CreateDateFrom=' + encodeURIComponent(lastRun.createDate);
        }
        if (params.ruleName) {
            urlParams +='&HH$RuleName=' + encodeURIComponent(params.ruleName);
        }
        urlParams += '&HH$pageSize='+encodeURIComponent(count);
        var res = sendRequest(finalUrl, 'alert',  urlParams).HedgehogXmlApi;
        var incidents = null;
        var newLastRun = null;
        if (res && res.alert && res.alert.length > 0) {
            //Create incidents
            incidents = alertsToIncident(res.alert);
            //Set last run
            newLastRun = calculateNewLastRun(res.alert);
        } else if (res && res.alert) {
            //This is a sinlge alert
            //Create incidents
            incidents = [alertToIncident(res.alert)];
            //Set last run
            newLastRun = calculateNewLastRun(res.alert);
        }
        if (newLastRun) {
            setLastRun({createDate: newLastRun});
        }
        return incidents;
    };

    // The command input arg holds the command sent from the user.
    switch (command) {
        // This is the call made when pressing the integration test button.
        case 'test-module':
            sendRequest(finalUrl, 'sensor');
            return 'ok';
        case 'fetch-incidents':
            return JSON.stringify(fetchIncidents());
        case 'dam-get-alert-by-id':
            return sendRequest(finalUrl, 'alert', 'HH$Id=' + encodeURIComponent(args.id)).HedgehogXmlApi.alert;
        case 'dam-get-latest-by-rule':
            var count = args.count || 10;
            var timeBack = 1000 * 60 * (args.timeBack || 10);
            var res = sendRequest(finalUrl, 'alert', 'HH$RuleName=' + encodeURIComponent(args.ruleName) +
                '&HH$TimeBackPeriod='+encodeURIComponent(timeBack +'') + '&HH$pageSize='+encodeURIComponent(count)).HedgehogXmlApi;
            if (res && res.alert) {
                return {alerts: res.alert};
            }
            return null;
    }
  type: javascript
  commands:
  - name: dam-get-alert-by-id
    arguments:
    - name: id
      required: true
      default: true
      description: The alert ID
    description: Get a DAM alert from Mcafee Database Activity Monitoring by alert
      id
  - name: dam-get-latest-by-rule
    arguments:
    - name: ruleName
      required: true
      default: true
      description: Name of rule that triggered the alert
    - name: count
      description: Number of alerts to retrieve, defaults to 10
    - name: timeBack
      description: Filter DAM alerts and bring alerts that where created only in the
        last timeBack minute, defaults to last 10 minutes
    description: Get latest DAM alerts by rule name
  isfetch: true
system: true
