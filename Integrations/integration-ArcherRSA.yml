commonfields:
  id: RSA Archer
  version: -1
name: RSA Archer
display: RSA Archer
category: IT Services
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAATCAYAAABbV8lLAAAG2UlEQVR4Ae3YA4xzaRjF8ftZY9tr27Zt27Zt27Zt27atYoy2c9uz/zxps2+advW1M8Gc5DdTt+m5L2494oVaZt8GJ+D4UXJCtG3ODQ4sKR/Px5kbc2IcxjLzsYJvwc/4aTSEee+B1jnOWW9GYTEfZ2dsgULkKGMFPwONli781jzbNc0TJ83BxzkP+2MR5ChjBT8JmdY5FKxuVrCsPgnlqGpSqHk2txgFa1sVrGiw/9xvl0MNHeI1nMehcRa7j8dkLDiM3tY5rl1q6vQKPs6h2BuVcDNxJqbtSVgGmyOfmYRiTMT/zXSUYWJeCg7Wtan/6BMUueteRe59QJH7HlTkznvUd+BhCnfMZQWmyu3eZCtFH3tS8Z9+1vBHH2vwvIvUteIaqccAXO5caCkNnHOB+g450srOVHKkbc6b4JHJmAQ3+yGA5zEe/zXtEN5EPjIFJ6MHQg8uQD2Idz5+QRBhfIl94KYKNyIGoQt75L7gqmbFnn9JRP7nX8r/7AvFf/hRRMNvvKVQ+1yM6Ab17XOgiOK//GIHQPSZ55To7ORAOFzBysa/RnlZnQYvvlypdK28loI1rZlG8U3wMiFvQ/AxL/5rGhHHS3katU9CeB1n4wXEsCiIdxOEd/ESohB2BPHK8TWEe3EAnseaeSr4RflffS2KAlNvSY0GTj5dRL077aHA9HJFn3qWxn2F51xQgYJKm8aZwoFUcU2z2n//y6+U6O8X0dCV1yhYWpdpFN8EL12y0BiCEA5FKjXYBo3YB6uBeEvjJByMStQhjmewKE7AvpgCN1vjeKyDVEqwKeqwPTaEmx0hvAU3ZUjlRggLwyPrQ7gfHjkUwrVIT54K/vobWUG1bQrMqFDPRltIpG+/QxSYUqLIHXdLhOncpmFbq2udkQkOEA6I3WWPO/wYxV57Q/E/AgrPsYAzVf9jwftCOAjdeMtZiy+CEIawDfaCHBejFL2IQo6r4ZFCPAchAuEiuO//O4ST4OZ+CAcgW26EnI3jhhDugjtDrT2yBVNC97qb2HTsM01raEhdS61oo7pz8eXkf/q5RBJdXYo88LC619vE3YyxWWuxUhN9/XZbalrvP+hwG/H/suBHkUATXkYc7fDIHhDuxaKYAzH8iFrMgVLUIoJfsQwWRwKfwiN7QjgOHnkQQi3Wg/AylkIJUhmP9yFshom4AjfhRuwMj9wA4U08hUEI62M8foKw9EgWbCX0n3CKRPxvv1P3mhuwfrbIdsn17ZTG7neHXW0Nlu9LZOia68VGzV6ne+0NJTJ4xTU2zYdnnddGMFO2Fc4Mkb1gkHr4eBuluB7CvmkFbwdi/4Xb4aYRCTBKLXXw8TE88hCER3AlPoGwDFaHcAjSMx4fIFmw5Tso6Wa3YKfYP5ypvhC/Qlh2JAu2qZdRbIWAy7P+VUqyIAq3jVSI8mIvv5raSNm6HLntTon0bLB58tSrznbadts2O9kU/g8F7wJl8DQ8sjuEXeGRgyDckGWT9aJz3cdH8MizEH7Gd/gcH2IZrAnhaGTKwxD2dgrbFcI1aQWvjncQBaPXMsE5oNYd6TXYzl97ttxeRANnnmclWbmzzCNw3c6RFZhYqMELLhGxkRueZ2ElBgY0/MFHdqDwHFuju1ZZS/Ljir3wkpXO7VkLdr68S3AMTsEg+lGIndIKXgPCU0hlAuoyFOyO4AshbI30bPoPBe8O4WWksl6WghfAshB+QxE8cgqEe9Nmh4n5KfiV1xT/8ScrGFZE7PU3pXhCXUuvpGBRtYZuuFnxUFgD516oPtZUznOlSET+N9/a2jt4zoUi6jvgUDutcjdesSefFmF939hmgEwFkyYI32cZMVthGwh7OKPnWwgX4UHcjzoIr8N97a/gkbmdnfoBOBsfoggbQTgemTIJT0B4B+fjTQg3wSO3Qlg+bY3nsZYqfAfhbZyPr3Fj7gtmlA1edpUid99n5TLCrITuNde3kvuPPckK62WK5VRJCTZellhMkQcfUeeiyyjEGhx96FEbpeG5FnJ3zFZ+9wabafid9+zAYPRnK3gVvIjD4WZzvIA9sDJeSNt9zofH0YsvsDvK8TQucL7Qp3GtsyNfBa9C+AWnYRqWwQvYBtkyFUfjPQTwDs5FBzxyBJ4Hn80yG57GE6gBsf+X4Gv04TXskIefKimBQp0v3jZVdipU0WibK67bgUDR9sNHeP7FbLp2fqq0Inm8u5E6Cx+4r5V6rFtwrlhx/y9TMNoZn5c1+H9J7Yb5z/VsujAd+0Bp8lLwGCB14Skoj86ChxL8BmVwM7wx+Sn4AfShN8f60In54SUdjaEMroU3Jj8F74crcFmOXY4LUAYvaXlcl8Gu8HJrzJ/ys/Ol4zdDCgAAAABJRU5ErkJggg==
description: The RSA Archer GRC Platform provides a common foundation for managing
  policies, controls, risks, assessments and deficiencies across lines of business.
configuration:
- display: Server URL (e.g. https://192.168.0.1/rsaarcher/)
  name: server
  defaultvalue: ""
  type: 0
  required: true
- display: Instance name
  name: instanceName
  defaultvalue: ""
  type: 0
  required: true
- display: Username
  name: credentials
  defaultvalue: ""
  type: 9
  required: true
- display: Do not validate server certificate (insecure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
- display: Fetch incidents
  name: isFetch
  defaultvalue: ""
  type: 8
  required: false
- display: Incident type
  name: incidentType
  defaultvalue: ""
  type: 13
  required: false
- display: 'Date field name for fetch (en-US format: 07/22/2016 3:58 PM)'
  name: fetchByField
  defaultvalue: Date Created
  type: 0
  required: false
- display: Fields for fetch (comma separated)
  name: fetchFields
  defaultvalue: Title,Incident ID
  type: 0
  required: false
- display: Timezone offset in minutes of the RSA Archer server machine (+60, -60,
    in minutes)
  name: timeZone
  defaultvalue: ""
  type: 0
  required: false
- display: Application ID for fetch
  name: fetchApplicationId
  defaultvalue: ""
  type: 0
  required: false
script:
  script: |-
    var server = params.server.replace(/[\/]+$/, '');

    var commands = {
      createRecord:     'archer-create-record',
      updateRecord:     'archer-update-record',
      getRecord:        'archer-get-record',
      searchApps:       'archer-search-applications',
      searchRecords:    'archer-search-records',
      getAppFields:     'archer-get-application-fields',
      deleteRecord:     'archer-delete-record',
      valueListForField: 'archer-value-list-for-field',
      fetchIncidents: 'archer-fetch-incidents',
      getReports: 'archer-get-reports',
      executeStatisticSearchByReport: 'archer-execute-statistic-search-by-report',
      getSearchOptionsByGuid: 'archer-get-search-options-by-guid',
      searchRecordsByReport: 'archer-search-records-by-report',
    };

    var urlDictionary = {};
    urlDictionary.login = '/ws/general.asmx';
    urlDictionary.logout = '/ws/general.asmx';
    urlDictionary.levelIdByModuleId = '/api/core/system/level/module/%applicationId%';
    urlDictionary.fieldByLevelId = '/api/core/system/fielddefinition/level/%levelId%';
    urlDictionary[commands.createRecord] = '/ws/record.asmx';
    urlDictionary[commands.updateRecord] = '/ws/record.asmx';
    urlDictionary[commands.getRecord] = '/ws/record.asmx';
    urlDictionary[commands.searchApps] = '/api/core/system/application';
    urlDictionary[commands.searchRecords] = '/ws/search.asmx';
    urlDictionary[commands.deleteRecord] = '/ws/record.asmx';
    urlDictionary[commands.valueListForField] = '/ws/field.asmx';
    urlDictionary[commands.getReports] = '/ws/search.asmx';
    urlDictionary[commands.executeStatisticSearchByReport] = '/ws/search.asmx';
    urlDictionary[commands.getSearchOptionsByGuid] = '/ws/search.asmx';
    urlDictionary[commands.searchRecordsByReport] = '/ws/search.asmx';

    var methodDictionary = {};
    methodDictionary.login = 'POST';
    methodDictionary.logout = 'POST';
    methodDictionary.levelIdByModuleId = 'POST';
    methodDictionary.fieldByLevelId = 'POST';
    methodDictionary[commands.createRecord] = 'POST';
    methodDictionary[commands.updateRecord] = 'POST';
    methodDictionary[commands.getRecord] = 'POST';
    methodDictionary[commands.searchApps] = 'POST';
    methodDictionary[commands.searchRecords] = 'POST';
    methodDictionary[commands.deleteRecord] = 'POST';
    methodDictionary[commands.valueListForField] = 'POST';
    methodDictionary[commands.getReports] = 'POST';
    methodDictionary[commands.executeStatisticSearchByReport] = 'POST';
    methodDictionary[commands.getSearchOptionsByGuid] = 'POST';
    methodDictionary[commands.searchRecordsByReport] = 'POST';

    function extractObjectFromXML(xml, path) {
        var searchRes = dq(xml, path);
        if (searchRes === "" || searchRes === null){
            return [];
        }
        if (searchRes.indexOf("<?xml") > -1) {
            var index = searchRes.indexOf(">");
            if (index !== -1) {
                searchRes = searchRes.substr(index + 1);
            }
        }
        return JSON.parse(x2j(searchRes));
    }

    function parseRecordsXml(token, response, mapping) {
        var parsedJson = extractObjectFromXML(response, 'Envelope.Body.ExecuteSearchResponse.ExecuteSearchResult');
        var records = parsedJson.Records.Record;
        if (!records) {
            return [];
        }
        var mapping = mapping;
        var outputs =[];
        records = varifyOrMakeArray(records);
        records.forEach(function (record) {
            // iterating over all of the records
            var contentId = record['-contentId'];
            var moduleId = record['-moduleId'];
            var toContext = {
                Id: contentId,
                ModuleId: moduleId,
                Fields: {}
            };
            // used later on to check if we need to bring more mappings
            var seenModuleIds = {};
            seenModuleIds[moduleId] = moduleId;
            var fields = varifyOrMakeArray(record.Field);
            args.contentId = contentId;
            args.applicationId = moduleId;
            // Getting top level record and iterating over it to get the linked records
            var recordObject = getRecord(commands.getRecord, token, null, contentId, moduleId).keyValsForFetch;

            toContext.Fields.Record = recordObject;
            var innerRecords = varifyOrMakeArray(recordObject.innerRecords); // contains all possible inner fields
            innerRecords.forEach(function (innerRecord){
                if (innerRecord){
                    var innerRecordContentId = innerRecord.contentId;
                    var innerRecordModuleId = innerRecord.ModuleId || args.applicationId;
                    args.contentId = innerRecordContentId;
                    if(innerRecordModuleId && !(innerRecordModuleId in seenModuleIds)){
                        var newModuleId = innerRecordModuleId;
                        args.applicationId = newModuleId;
                        var newMapping = createMapping(token);
                        for (var attrname in newMapping) { mapping[attrname] = newMapping[attrname]; }
                        seenModuleIds[newModuleId] = newModuleId;
                    }
                    innerRecord.Record = getRecord(commands.getRecord, token, mapping, innerRecordContentId, innerRecordModuleId).keyValsForFetch;
                }

            });
            fields.forEach(function (field) {
                toContext.Fields[mapping[field['-id']].Name] = field['#text'];
            });
            outputs.push(toContext);
        });

        return outputs;
    }

    function soapRequestSender(cmd, bodyContent, SOAPAction) {
        var headers = {'Content-Type': ['text/xml; charset=utf-8']};
        if (SOAPAction) {
            headers.SOAPAction = [SOAPAction];
        }
        var url =  server +  urlDictionary[cmd];
        var result = http(
            url,
            {
                Method: methodDictionary[cmd],
                Headers: headers,
                Body: bodyContent
            },
            params.insecure,
            params.proxy
        );
        return result;
    }

    function sendSoapRequest(cmd, bodyContent, SOAPAction) {
        var headers = {'Content-Type': ['text/xml; charset=utf-8']};
        if (SOAPAction) {
            headers.SOAPAction = [SOAPAction];
        }
        var url =  server +  urlDictionary[cmd];
        var result = http(
            url,
            {
                Method: methodDictionary[cmd],
                Headers: headers,
                Body: bodyContent
            },
            params.insecure,
            params.proxy
        );

        if (result.StatusCode < 200 || result.StatusCode >= 300) {
            throw 'Request to RSA Archer ' + url + ' failed, request status code: ' + result.StatusCode + ' and Body: ' + result.Body + '.';
        }

        return result.Body;
    }


    function getRecordSendSoapRequest(cmd, applicationId, contentId, token) {
        var currentToken = token;
        for(var i = 0; i<10; i++){
            var soap = getContentSoapRequest(currentToken, applicationId, contentId);

            var SOAPAction = 'http://archer-tech.com/webservices/GetRecordById';
            var result = soapRequestSender(cmd, soap, SOAPAction);
            if (result.StatusCode < 200 || result.StatusCode >= 300) {
                if (result.StatusCode === 500 || result.StatusCode === -1){ // unauthorized, try again
                    currentToken = reLogin(currentToken);
                    continue;
                }
                throw 'Request to RSA Archer ' + url + ' failed, request status code: ' + result.StatusCode + ' and Body: ' + result.Body + '.';
            }
            return result.Body;
        }
    }


    function sendRestRequest(cmd, bodyContent, token, httpTunneling, queryParams) {
        var headers = {
            'Content-Type': ['application/json'],
            'Accept': ['application/json']
        };

        if(httpTunneling) {
            headers['X-Http-Method-Override'] = ['GET'];
        }

        var url = server + replaceInTemplatesAndRemove(urlDictionary[cmd], args);
        if (queryParams) {
            url += queryParams;
        }

        var body = JSON.stringify(bodyContent);
        var currentToken = token;
        for(i = 0; i<10; i++){
            if (currentToken) {
                headers.Authorization = ['Archer session-id=' + currentToken];
            }
            var result = http(
                url,
                {
                    Method: methodDictionary[cmd],
                    Headers: headers,
                    Body: body ? body : ''
                },
                params.insecure,
                params.proxy
            );

            if (result.StatusCode < 200 || result.StatusCode >= 300) {
                if (result.StatusCode === 401 || result.StatusCode === -1){ // unauthorized, try again
                    currentToken = reLogin(currentToken);
                    continue;
                }
                throw 'Request to RSA Archer ' + url + ' failed, request status code: ' + result.StatusCode + ' and Body: ' + result.Body + '.';
            }
            return JSON.parse(result.Body);
        }
    }

    function searchSendSoapRequest(cmd, token, appId, fields, maxResults, fieldIdToSearchOn, fieldNameToSearchOn, searchValue, fieldIdToSearchOn, isDescending, numericOperator, dateOperator, pageNumber) {
        var currentToken = token;
        for(var i = 0; i<10; i++){
            var soap = getContentsByAppIdRequest(currentToken, appId, fields, maxResults, fieldIdToSearchOn, fieldNameToSearchOn, searchValue, fieldIdToSearchOn, isDescending, numericOperator, dateOperator, pageNumber);
            var SOAPAction = 'http://archer-tech.com/webservices/ExecuteSearch';
            var result = soapRequestSender(cmd, soap, SOAPAction);
            if (result.StatusCode < 200 || result.StatusCode >= 300) {
                if (result.StatusCode === 500){ // unauthorized, try again
                    currentToken = reLogin(currentToken);
                    continue;
                }
                throw 'Request to RSA Archer ' + url + ' failed, request status code: ' + result.StatusCode + ' and Body: ' + result.Body + '.';
            }
            return result.Body;
        }
    }

    function createUserSessionFromInstanceSoapRequest(instanceName, userName, password) {
        return (
        '<?xml version="1.0" encoding="utf-8"?>' +
        '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">' +
        '  <soap:Body>' +
        '    <CreateUserSessionFromInstance xmlns="http://archer-tech.com/webservices/">' +
        '      <userName>' + userName + '</userName>' +
        '      <instanceName>' + instanceName + '</instanceName>' +
        '      <password>' + password + '</password>' +
        '    </CreateUserSessionFromInstance>' +
        '  </soap:Body>' +
        '</soap:Envelope>'
        );
    }

    function terminateSessionSoapRequest(token) {
        return(
        '<?xml version="1.0" encoding="utf-8"?>' +
        '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">' +
        '    <soap:Body>' +
        '        <TerminateSession xmlns="http://archer-tech.com/webservices/">' +
        '        <sessionToken>' + token + '</sessionToken>' +
        '        </TerminateSession>' +
        '    </soap:Body>' +
        '</soap:Envelope>'
        );
    }

    function getContentsByAppIdRequest(token, appId, displayFields, maxResults, fieldIdToSearchOn, fieldNameToSearchOn, searchValue, sortByFieldId, isDescending, numericOperator, dateOperator, pageNumber) {
        var readyMaxReults = (maxResults === undefined || maxResults === null) ? '100' : maxResults;
        return (
        '<?xml version="1.0" encoding="UTF-8"?>' +
        '<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">' +
        '   <soap:Body>' +
        '       <ExecuteSearch xmlns="http://archer-tech.com/webservices/">' +
        '           <sessionToken>' + token + '</sessionToken>' +
        '           <searchOptions>' +
        '               <![CDATA[' +
        '                   <SearchReport>' +
        '                       <PageSize>' + readyMaxReults + '</PageSize>' +
        '                       <PageNumber>' + pageNumber + '</PageNumber>' +
        '                       <MaxRecordCount>' + (readyMaxReults || '1') + '</MaxRecordCount>' +
        '                       <ShowStatSummaries>false</ShowStatSummaries>' +
        '                       <DisplayFields>' + displayFields + '</DisplayFields>' +
        '                       <Criteria>' +
        '                           <ModuleCriteria>' +
        '                               <Module name="appname">' + appId + '</Module>' +
        '                           </ModuleCriteria>' +
                                    (fieldIdToSearchOn ?
        '                           <Filter>' +
        '                               <Conditions>' +
                                            (dateOperator ?
        '                                   <DateComparisonFilterCondition>' +
        '                                       <Operator>' + dateOperator + '</Operator>' +
        '                                       <Field name="'+ escapeXMLChars(fieldNameToSearchOn) +'">' + fieldIdToSearchOn + '</Field>' +
        '                                       <Value>' + searchValue + '</Value>' +
        '                                       <TimeZoneId>UTC Standard Time</TimeZoneId>' +
        '                                       <IsTimeIncluded>TRUE</IsTimeIncluded>' +
        '                                   </DateComparisonFilterCondition>' : '') +
                                            ((!dateOperator && numericOperator) ?
        '                                   <NumericFilterCondition>' +
        '                                       <Operator>' + numericOperator + '</Operator>' +
        '                                       <Field name="'+ escapeXMLChars(fieldNameToSearchOn) +'">' + fieldIdToSearchOn + '</Field>' +
        '                                       <Value>' + searchValue + '</Value>' +
        '                                   </NumericFilterCondition>' : '') +
                                            ((!dateOperator && !numericOperator) ?
        '                                   <TextFilterCondition>' +
        '                                       <Operator>Contains</Operator>' +
        '                                       <Field name="'+ escapeXMLChars(fieldNameToSearchOn) +'">' + fieldIdToSearchOn + '</Field>' +
        '                                       <Value>' + searchValue + '</Value>' +
        '                                   </TextFilterCondition>' : '') +
        '                               </Conditions>' +
        '                           </Filter>'
                                    : '') +
                                    (sortByFieldId ?
        '                           <SortFields>' +
        '                               <SortField>' +
        '                                   <Field>' + sortByFieldId + '</Field>' +
        '                                   <SortType>' + (isDescending ? 'Descending' : 'Ascending') + '</SortType>' +
        '                               </SortField>' +
        '                           </SortFields>'
                                    : '') +
        '                       </Criteria>' +
        '                   </SearchReport>' +
        '               ]]>' +
        '           </searchOptions>' +
        '           <pageNumber>1</pageNumber>' +
        '       </ExecuteSearch>' +
        '   </soap:Body>' +
        '</soap:Envelope>'
        );
    }

    function createContentSoapRequest(token, appId, fields) {
        return (
        '<?xml version="1.0" encoding="utf-8"?>' +
        '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema- instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">' +
        '   <soap:Body>' +
        '       <CreateRecord xmlns="http://archer-tech.com/webservices/">' +
        '           <sessionToken>' + token + '</sessionToken>' +
        '           <moduleId>' + appId + '</moduleId>' +
        '           <fieldValues> ' +
        '               <![CDATA[ ' +
        '                   <Record>' + fields + '</Record>' +
        '                ]]>' +
        '           </fieldValues>' +
        '       </CreateRecord>' +
        '   </soap:Body> ' +
        '</soap:Envelope>'
        );
    }

    function updateContentSoapRequest(token, appId, contentId, fields) {
        return (
        '<?xml version="1.0" encoding="utf-8"?> ' +
        '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchemainstance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">' +
        '   <soap:Body>' +
        '       <UpdateRecord xmlns="http://archer-tech.com/webservices/">' +
        '           <sessionToken>' + token + '</sessionToken>' +
        '           <moduleId>' + appId + '</moduleId>' +
        '           <contentId>' + contentId +'</contentId>' +
        '           <fieldValues>' +
        '               <![CDATA[' +
        '                   <UpdateRecord>' + fields + '</UpdateRecord>' +
        '               ]]>' +
        '           </fieldValues>' +
        '       </UpdateRecord>' +
        '   </soap:Body>' +
        '</soap:Envelope>'
        );
    }

    function getContentSoapRequest(token, appId, contentId) {
        return (
        '<?xml version="1.0" encoding="utf-8"?> ' +
        '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchemainstance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">' +
        '   <soap:Body>' +
        '       <GetRecordById xmlns="http://archer-tech.com/webservices/">' +
        '           <sessionToken>' + token + '</sessionToken>' +
        '           <moduleId>' + appId + '</moduleId>' +
        '           <contentId>' + contentId +'</contentId>' +
        '       </GetRecordById>' +
        '   </soap:Body>' +
        '</soap:Envelope>'
        );
    }

    function deleteContentSoapRequest(token, appId, contentId) {
        return (
        '<?xml version="1.0" encoding="utf-8"?>' +
        '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchemainstance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">' +
        '   <soap:Body>' +
        '       <DeleteRecord xmlns="http://archer-tech.com/webservices/">' +
        '           <sessionToken>' + token + '</sessionToken>' +
        '           <moduleId>' + appId + '</moduleId>' +
        '           <contentId>' + contentId + '</contentId>' +
        '       </DeleteRecord>' +
        '   </soap:Body>' +
        '</soap:Envelope>'
        );
    }

    function getValueListForFieldSoapRequest(token, fieldID){
        return (
        '<?xml version="1.0" encoding="utf-8"?>'+
        '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchemainstance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'+
            '<soap:Body>'+
                '<GetValueListForField xmlns="http://archer-tech.com/webservices/">'+
                    '<sessionToken>'+token+'</sessionToken>'+
                    '<fieldId>'+fieldID+'</fieldId>'+
                '</GetValueListForField>'+
            '</soap:Body>'+
        '</soap:Envelope>'
        );
    }

    function getReportsSoapRequest(token){
        return (
        '<?xml version="1.0" encoding="utf-8"?>'+
        '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchemainstance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'+
            '<soap:Body>'+
                '<GetReports xmlns="http://archer-tech.com/webservices/">'+
                    '<sessionToken>'+token+'</sessionToken>'+
                '</GetReports>'+
            '</soap:Body>'+
        '</soap:Envelope>'
        );
    }

    function executeStatisticSearchByReportSoapRequest(token, reportGuid, maxResults) {
        return (
        '<?xml version="1.0" encoding="utf-8"?>' +
        '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">' +
        '  <soap:Body>' +
        '    <ExecuteStatisticSearchByReport xmlns="http://archer-tech.com/webservices/">' +
        '      <sessionToken>' + token + '</sessionToken>' +
        '      <reportIdOrGuid>' + reportGuid + '</reportIdOrGuid>' +
        '      <pageNumber>' + maxResults + '</pageNumber>' +
        '    </ExecuteStatisticSearchByReport>' +
        '  </soap:Body>' +
        '</soap:Envelope>'
        );
    }

    function getSearchOptionsByGuidSoapRequest(token, reportGuid) {
        return (
        '<?xml version="1.0" encoding="utf-8"?>' +
        '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">' +
        '  <soap:Body>' +
        '    <GetSearchOptionsByGuid xmlns="http://archer-tech.com/webservices/">' +
        '      <sessionToken>' + token + '</sessionToken>' +
        '      <searchReportGuid>' + reportGuid + '</searchReportGuid>' +
        '    </GetSearchOptionsByGuid>' +
        '  </soap:Body>' +
        '</soap:Envelope>'
        );
    }

    function searchRecordsByReportSoapRequest(token, reportGuid, maxResults) {
        return (
        '<?xml version="1.0" encoding="utf-8"?>' +
        '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">' +
        '  <soap:Body>' +
        '    <SearchRecordsByReport xmlns="http://archer-tech.com/webservices/">' +
        '      <sessionToken>' + token + '</sessionToken>' +
        '      <reportIdOrGuid>' + reportGuid + '</reportIdOrGuid>' +
        '      <pageNumber>' + maxResults + '</pageNumber>' +
        '    </SearchRecordsByReport>' +
        '  </soap:Body>' +
        '</soap:Envelope>'
        );
    }

    function getLevelsByApplicationId(token) {
        var lvlResponse = sendRestRequest('levelIdByModuleId', '', token, true);
        return dq(lvlResponse, 'RequestedObject.Id');
    }

    function createMappingFieldIdToName(levels, token) {
        var mapping = {};
        if (!levels) {
            throw 'Mapping levels to Fields failed';
        }

        if (!Array.isArray(levels)) {
            levels = [levels];
        }

        levels.forEach(function (lvl) {
            args.levelId = lvl;
            var fieldsLevelInfo = sendRestRequest('fieldByLevelId', '' ,token, true);

            if (!Array.isArray(fieldsLevelInfo)) {
               fieldsLevelInfo = [fieldsLevelInfo];
            }

            fieldsLevelInfo.forEach(function (field) {
                if (field.RequestedObject.Type !== 25) {
                    mapping[field.RequestedObject.Id] = {
                        Type: field.RequestedObject.Type,
                        Name: field.RequestedObject.Name,
                        levelId: lvl
                    };
                }
            });
        });

        return mapping;
    }

    function createMappingNameToFieldId(levels, token) {
        var mapping = {};
        if (!levels) {
            throw 'Mapping levels to Fields failed';
        }

        if (!Array.isArray(levels)) {
            levels = [levels];
        }

        levels.forEach(function (lvl) {
            args.levelId = lvl;
            var fieldsLevelInfo = sendRestRequest('fieldByLevelId', '', token, true);

            if (!Array.isArray(fieldsLevelInfo)) {
                fieldsLevelInfo = [fieldsLevelInfo];
            }

            fieldsLevelInfo.forEach(function (field) {
                if (field.RequestedObject.Type !== 25) {
                    mapping[field.RequestedObject.Name] = {
                        Type: field.RequestedObject.Type,
                        Id: field.RequestedObject.Id,
                        levelId: lvl
                    };
                }
            });
        });

        return mapping;
    }

    function mapContentFieldNameToValue(mapping, fields, applicationId) {
        // we have records who are linked to the record we are working on.
        // humanReadableTables will have the data related to the linked records
        // recordVals will have the data related to the work record, and brief summary of the linked records
        var recordVals = [];
        var innerRecordsArray = [];
        var mapping = mapping;
        if (fields) {
            var humanReadableTables = [];
            fields.forEach(function (field) {
                var groupValue
                if (field.Groups) { // handling the nested Groups field
                    var group = field.Groups.Group;
                    if (group) {
                        group = varifyOrMakeArray(group);
                        group.forEach(function (gr) {
                            groupValue = groupValue ? groupValue + ',' + gr['-name'] : gr['-name']
                        })
                    }
                }
                // used later on to check if we need to bring more mappings
                var seenModuleIds = {};
                seenModuleIds[applicationId] = applicationId;

                // innerRecordrows and innerRecordcolumns are used to create the human readable
                var innerRecordrows = [];

                if (field.Record) { // handling the nested Record field
                    var innerRecords = varifyOrMakeArray(field.Record);
                    var tableName = mapping[field['-id']].Name;
                    var innerRecordcolumns = [];
                    innerRecords.forEach(function(innerRecord){
                    // iterating over the inner records and creating an row Object for each of them
                        if(innerRecord){
                            var row = {};
                            recordFields = varifyOrMakeArray(innerRecord['Field']);
                            innerRecordcolumns.push('ModuleId');
                            var newModuleId;
                            if(innerRecord['-moduleId']){ // means that it is a linked record from another module
                                newModuleId = innerRecord['-moduleId'];
                                args.applicationId = newModuleId;
                                if (!(newModuleId in seenModuleIds)){ // checking if we need to bring more mappings
                                    var newMapping = createMapping(token);
                                    for (var attrname in newMapping) { mapping[attrname] = newMapping[attrname]; }
                                    seenModuleIds[newModuleId] = newModuleId;
                                }
                            }
                            row['ModuleId'] = newModuleId || applicationId;
                            var innerRecordObject = {'ModuleId': row['ModuleId'],'contentId':innerRecord['-id']};
                            if (innerRecordsArray.indexOf(innerRecordObject) === -1){
                                innerRecordsArray.push (innerRecordObject);
                            }
                            recordFields.forEach(function (f){
                                // building the columns of the human readable
                                if (mapping[f['-id']] && innerRecordcolumns.indexOf(mapping[f['-id']].Name) === -1){
                                    innerRecordcolumns.push(mapping[f['-id']].Name);
                                }
                                // building a row
                                var rowValue = f['-value'] || " ";
                                if(mapping[f['-id']] && mapping[f['-id']].Name){
                                    row[mapping[f['-id']].Name] = rowValue;
                                }
                            });
                            innerRecordrows.push(row);
                        }
                    });
                    humanReadableTables.push([tableName, innerRecordcolumns, innerRecordrows]);
                }
                // if there are no items in innerRecordrows we set it to null to ensure that the contexts would have null and not []
                if (innerRecordrows === undefined || innerRecordrows.length === 0){
                    innerRecordrows = null;
                }
                recordVals.push({
                    FieldId: field['-id'],
                    FieldName: mapping[field['-id']].Name,
                    FieldType: field['-type'],
                    Value: groupValue || field['-value'] || innerRecordrows,
                    LevelId: field['-id']
                });
            });
            recordVals.push({
                FieldName: 'innerRecords',
                Value: innerRecordsArray,
                FieldId: " ",
                LevelId: " ",
                FieldType: " "
            });
        }
        return [recordVals, humanReadableTables];
    }

    function varifyOrMakeArray(arr){
        return Array.isArray(arr)? arr : [arr];
    }
    function createContentContext (recordId, records) {
        var context = {};
        var fields = {};
        records.forEach(function (r) {
            fields[r.FieldName] = r.Value;
        });
        context.Id = recordId;
        context.Fields = fields;
        return context;
    }

    function createKeyValsForFetch (recordId, records) {
        var keyVals = {};
        records.forEach(function (r) {
            keyVals[r.FieldName] = r.Value;
        });
        keyVals.recordId = recordId;
        return keyVals;
    }
    function getAppFields(token) {
        var applicationId = args.applicationId;
        var levels = getLevelsByApplicationId(token);
        var mapping = createMappingFieldIdToName(levels, token);
        var md = [];
        for (var fieldId in mapping) {
            md.push({
                FieldId: fieldId,
                FieldName: mapping[fieldId].Name,
                FieldType: mapping[fieldId].Type,
                LevelId: mapping[fieldId].levelId
            })
        }

        return {
            Type: entryTypes.note,
            Contents: mapping,
            ContentsFormat: formats.json,
            HumanReadable: tableToMarkdown(command, md),
            ReadableContentsFormat: formats.markdown
        };
    }
    function createMapping(token){
        var levels = getLevelsByApplicationId(token);
        return createMappingFieldIdToName(levels, token);
    }

    function getRecord(command, token, mapping, contentId, applicationId) {
        var contentId = contentId || args.contentId;
        var applicationId = applicationId || args.applicationId;
        var mapping = mapping || createMapping(token);
        var rawResponse = getRecordSendSoapRequest(command, applicationId, contentId, token);
        var response = JSON.parse(x2j(rawResponse));

        if (typeof rawResponse !== 'string' || rawResponse.length == 0) {
            throw "Error in response. Request = " + soap + " Response = " + rawResponse;
        }
        var parsedJSON = extractObjectFromXML(response, 'Envelope.Body.GetRecordByIdResponse.GetRecordByIdResult');
        var contentMapping = mapContentFieldNameToValue(mapping, parsedJSON.Record.Field, applicationId);
        var nameToValue = contentMapping[0];
        var innerRecordValues =  contentMapping[1];
        var innerRecordsMarkdown = createInnerRecordsHumanReadable(innerRecordValues);
        var keyValsForFetch = createKeyValsForFetch(contentId, nameToValue);

        return {
            Type: entryTypes.note,
            Contents: parsedJSON,
            keyValsForFetch: keyValsForFetch,
            ContentsFormat: formats.json,
            ReadableContentsFormat: formats.markdown,
            HumanReadable: tableToMarkdown(command, nameToValue) + '\n\n' + innerRecordsMarkdown
            EntryContext: {'Archer.Content(true)': createContentContext(contentId, nameToValue)}
        };
    }

    function createInnerRecordsHumanReadable(tables){
        var markdown = "";
        tables.forEach(function (table){
            markdown += tableToMarkdown(table[0], table[2], table[1]);
        })
        return markdown;
    }
    function getListOfApplications(command, token) {
        var body = '';
        var applicatInfo = [];
        var queryParams = '';
        if (args.findByName !== undefined) {
            body = { Value: "?$filter=Name eq '" + args.findByName + "'" };
        } else if (args.findById) {
            queryParams = '/' + args.findById;
        }

        var applictions = sendRestRequest(command, body, token, true, queryParams)

        if (!Array.isArray(applictions)) {
            applictions = [applictions];
        }

        applictions.forEach(function (app) {
            var record = app.RequestedObject;
            if (record) {
                applicatInfo.push({
                    Type: record.Type,
                    LanguageId: record.LanguageId,
                    Id: record.Id,
                    Name: record.Name,
                    Guid: record.Guid,
                    Status: record.Status
                })
            }
        });

        return {
            Type: entryTypes.note,
            Contents: applicatInfo,
            ContentsFormat: formats.json,
            HumanReadable: tableToMarkdown(command, applicatInfo),
            ReadableContentsFormat: formats.markdown,
            EntryContext: {'Archer.Applications': applicatInfo}
        };
    }

    function inputToXML(fieldsToValue, mapping, token){
        var fields = '';
        for (var key in fieldsToValue) {
            if (mapping[key] !== undefined) {
                switch(mapping[key].Type){
                    case 1:
                    case 2:
                    case 3:
                    case 19:
                        fields += '<Field id="' + mapping[key].Id +'" value="' + fieldsToValue[key] + '" />';
                        break;
                    case 9:
                    case 18:
                        fields += '<Field id="' + mapping[key].Id +'" value="' + fieldsToValue[key][0] +'">';
                        for(var i=1; i<fieldsToValue[key].length; i++){
                            fields+= '<MultiValue value="'+fieldsToValue[key][i]+'" />';
                        }
                        fields+= '</Field>';
                        break;
                    case 4:
                        //fieldsToValue[key] is of the form [value1, value2,...]
                        listValueIdtoName = getValueListForField(commands.valueListForField, token ,{fieldID : mapping[key].Id});
                        fields += '<Field id="' + mapping[key].Id +'" value="' + listValueIdtoName[fieldsToValue[key][0]] +'">';
                        for(var i=1; i<fieldsToValue[key].length; i++){
                            fields+= '<MultiValue value="'+listValueIdtoName[fieldsToValue[key][i]]+'" />';
                        }
                        fields+= '</Field>';
                        break;
                    case 7:
                        //fieldsToValue[key] is of the form [{value: ___ , link: ___}, {value: ___ , link: ___}, ...]
                        fields += '<Field id="' + mapping[key].Id +'" value="' + fieldsToValue[key][0].value + '" link="'+fieldsToValue[key][0].link+'">';
                        for(var i=1; i<fieldsToValue[key].length; i++){
                            fields+= '<MultiValue value="'+fieldsToValue[key][i].value+'" link="'+fieldsToValue[key][i].link+'" />';
                        }
                        fields+= '</Field>';
                        break;
                    case 8:
                    case 15:
                        //fieldsToValue[key] is of the form {groups: [group1, group2,...], users : [user1, user2,...]}
                        fields+= '<Field id="' + mapping[key].Id + '" >';
                        groups = fieldsToValue[key].groups;
                        users = fieldsToValue[key].users;
                        if(groups && Array.isArray(groups) && groups.length > 0){
                            fields += '<Groups>';
                            for(var i=0; i<groups.length; i++){
                                fields += '<Group id="' + groups[i] + '" />';
                            }
                            fields += '</Groups>'
                        }
                        if(users && Array.isArray(users) && users.length > 0){
                            fields += '<Users>';
                            for(var i=0; i<users.length; i++){
                                fields += '<User id="' + users[i] + '" />';
                            }
                            fields += '</Users>'
                        }
                        fields+='</Field>';
                        break;
                    //case 14, 16 : not supported yet
                }
            }
        }
        return fields;
    }

    function createRecord(command, token, dataArgs) {
        var appId = dataArgs.applicationId;
        var fieldsToValue = JSON.parse(dataArgs.fieldsToValues);
        if (fieldsToValue === null || typeof fieldsToValue !== 'object') {
            throw 'Invalid Argument fieldToValue';
        }

        var levels = getLevelsByApplicationId(token);
        var mapping = createMappingNameToFieldId(levels, token);
        var fields = inputToXML(fieldsToValue, mapping, token);

        var soap = createContentSoapRequest(token, appId, fields);
        var SOAPAction = 'http://archer-tech.com/webservices/CreateRecord';
        var rawResponse = sendSoapRequest(command, soap, SOAPAction);
        var response = JSON.parse(x2j(rawResponse));

        if (typeof rawResponse !== 'string' || rawResponse.length == 0) {
            throw "Error in response. Request = " + soap + " Response = " + rawResponse;
        }

        var contentId = dq(response, 'Envelope.Body.CreateRecordResponse.CreateRecordResult');
        var md = fieldsToValue;
        md.Id = contentId;

        if (!contentId) {
            return {
                ContentsFormat: formats["markdown"],
                Type: entryTypes["error"],
                Contents: "Recived an error" + JSON.stringify(response)
            };
        }

        return {
            Type: entryTypes.note,
            Contents: response,
            ContentsFormat: formats.json,
            HumanReadable: tableToMarkdown(command, md),
            ReadableContentsFormat: formats.markdown,
            EntryContext: {'Archer.Content(true)': {Id: contentId , Fields: fieldsToValue}}
        };
    }

    function updateRecord(command, token, dataArgs) {
        var appId = dataArgs.applicationId;
        var contentId = dataArgs.contentId;
        var fieldsToValue = JSON.parse(dataArgs.fieldsToValues);

        if (fieldsToValue === null || typeof fieldsToValue !== 'object') {
            throw 'Invalid Argument fieldToValue';
        }

        var levels = getLevelsByApplicationId(token);
        var mapping = createMappingNameToFieldId(levels, token);
        var fields = inputToXML(fieldsToValue, mapping, token);

        var soap = updateContentSoapRequest(token,appId,contentId,fields);
        var SOAPAction = 'http://archer-tech.com/webservices/UpdateRecord';
        var rawResponse = sendSoapRequest(command, soap, SOAPAction);
        var response = JSON.parse(x2j(rawResponse));

        if (typeof rawResponse !== 'string' || rawResponse.length == 0) {
            throw "Error in response. Request = " + soap + " Response = " + rawResponse;
        }

        var result = dq(response, 'Envelope.Body.UpdateRecordResponse.UpdateRecordResult');
        if (!result && result < 1) {
            return {
                ContentsFormat: formats["markdown"],
                Type: entryTypes["error"],
                Contents: "Recived an error" + JSON.stringify(response)
            };
        }

        return {
            Type: entryTypes.note,
            ContentsFormat: formats.json,
            Contents: response,
            ReadableContentsFormat: formats.markdown,
            HumanReadable: 'content id = ' + contentId + ' was updated successfully'
        }
    }

    function getValueListForField(command, token, dataArgs){
        var SOAPAction = 'http://archer-tech.com/webservices/GetValueListForField';
        var fieldID = dataArgs.fieldID;
        var soap = getValueListForFieldSoapRequest(token, fieldID);
        var response = JSON.parse(x2j(sendSoapRequest(command, soap, SOAPAction)));
        var result = dq(response, 'Envelope.Body.GetValueListForFieldResponse.GetValueListForFieldResult');
        result = dq(JSON.parse(x2j(result)), 'SelectDef.SelectDefValues.SelectDefValue(true)={Name: val.Name, Id : val.Id}');
        var ret = {};
        for(key in result){
            ret[result[key]['Name']] = result[key]['Id'];
        }
        return ret;
    }

    function getValueObjectForFieldId(token, dataArgs){
        var fieldID = dataArgs.fieldID;
        var mapping = createMapping(token);
        var result = mapping[fieldID];
        try {
            result.FieldId = fieldID;
        } catch (e){
            //no match for this fieldID
        }
        return result;
    }

    function deleteRecord(command, token, dataArgs) {
        var appId = dataArgs.applicationId;
        var contentId = dataArgs.contentId;
        var soap =  deleteContentSoapRequest(token, appId, contentId);
        var SOAPAction = 'http://archer-tech.com/webservices/DeleteRecord';
        var rawResponse = sendSoapRequest(command, soap, SOAPAction);
        var response = JSON.parse(x2j(rawResponse));

        if (typeof rawResponse !== 'string' || rawResponse.length == 0) {
            throw "Error in response. Request = " + soap + " Response = " + rawResponse;
        }

        var result = dq(response, 'Envelope.Body.DeleteRecordResponse.DeleteRecordResult');
        if (!result && result < 1) {
            return {
                ContentsFormat: formats.markdown,
                Type: entryTypes.error,
                Contents: "Recived an error while deleting record: " + JSON.stringify(response)
            };
        }

        return {
            Type: entryTypes.note,
            Contents: 'content id = ' + contentId + ' was deleted successfully'
        }
    }

    function searchRecords(command, token, dataArgs) {
        var appId = dataArgs.applicationId;
        var fieldsToDisplay = dataArgs.fieldsToDisplay;
        var maxResults = dataArgs.maxResults;
        var fieldToSearchOn = dataArgs.fieldToSearchOn;
        var searchValue = dataArgs.searchValue;
        var numericOperator = dataArgs.numericOperator;
        var dateOperator = dataArgs.dateOperator;
        var isDescending = dataArgs.Descending;
        var pageNumber = dataArgs.pageNumber || '1';

        var levels = getLevelsByApplicationId(token);
        var mapping = createMappingNameToFieldId(levels, token);
        var reversemapping = createMappingFieldIdToName(levels, token);
        var fields = ''

        if (!fieldsToDisplay) {
            fieldsToDisplay = Object.keys(mapping);
        }

        if (fieldsToDisplay && !Array.isArray(fieldsToDisplay)){
            fieldsToDisplay = fieldsToDisplay.split(',');
        }

        if (fieldsToDisplay) {
            fieldsToDisplay.forEach(function (field) {
                if (field && mapping[field] !== undefined) {
                    fields += '<DisplayField name="' + escapeXMLChars(field) +'">' + mapping[field].Id + '</DisplayField>';
                }
            });
        }

        var fieldIdToSearchOn;
        var fieldNameToSearchOn;
        if (fieldToSearchOn) {
            fieldIdToSearchOn = mapping[fieldToSearchOn] ? mapping[fieldToSearchOn].Id : '';
            fieldNameToSearchOn = fieldToSearchOn;
        }

        var rawResponse = searchSendSoapRequest(command, token, appId, fields, maxResults, fieldIdToSearchOn, fieldNameToSearchOn, searchValue, fieldIdToSearchOn, isDescending, numericOperator, dateOperator, pageNumber);
        var response = JSON.parse(x2j(rawResponse));
        if (typeof rawResponse !== 'string' || rawResponse.length == 0) {
            throw "Error in response. Response = " + rawResponse;
        }
        var output = parseRecordsXml(token, response, reversemapping);
        var md = [];
        output.forEach(function (out) {
            md.push(treeToFlattenObject(out));
        })

        return {
            Type: entryTypes.note,
            Contents: output,
            ContentsFormat: formats.json,
            HumanReadable: tableToMarkdown(command, md),
            ReadableContentsFormat: formats.markdown,
            EntryContext: { 'Archer.Content(true)': output }
        };
    }

    function getReports(command, token) {
        var soap = getReportsSoapRequest(token);
        var SOAPAction = 'http://archer-tech.com/webservices/GetReports';
        var rawResponse = sendSoapRequest(command, soap, SOAPAction);
        var response = JSON.parse(x2j(rawResponse));

        if (typeof rawResponse !== 'string' || rawResponse.length == 0) {
            throw "Error in response. Request = " + soap + " Response = " + rawResponse;
        }

        var parsedJSON = extractObjectFromXML(response, 'Envelope.Body.GetReportsResponse.GetReportsResult');

        return {
            Type: entryTypes.note,
            Contents: parsedJSON,
            ContentsFormat: formats.json,
            ReadableContentsFormat: formats.markdown,
            EntryContext: {'Archer.Content(true)': parsedJSON}
        };
    }

    function executeStatisticSearchByReport(command, token, dataArgs) {
        var maxResults = dataArgs.maxResults || '100';
        var reportGuid = dataArgs.reportGuid;

        var soap = executeStatisticSearchByReportSoapRequest(token, reportGuid, maxResults);
        var SOAPAction = 'http://archer-tech.com/webservices/ExecuteStatisticSearchByReport';
        var rawResponse = sendSoapRequest(command, soap, SOAPAction);
        var response = JSON.parse(x2j(rawResponse));

        if (typeof rawResponse !== 'string' || rawResponse.length == 0) {
            throw "Error in response. Request = " + soap + " Response = " + rawResponse;
        }

        var parsedJSON = extractObjectFromXML(response, 'Envelope.Body.ExecuteStatisticSearchByReportResponse.ExecuteStatisticSearchByReportResult');

        return {
            Type: entryTypes.note,
            Contents: parsedJSON,
            ContentsFormat: formats.json,
            ReadableContentsFormat: formats.markdown,
            EntryContext: { 'Archer.Content(true)': parsedJSON}
        };
    }

    function getSearchOptionsByGuid(command, token, dataArgs) {
        var reportGuid = dataArgs.reportGuid;

        var soap = getSearchOptionsByGuidSoapRequest(token, reportGuid);
        var SOAPAction = 'http://archer-tech.com/webservices/GetSearchOptionsByGuid';
        var rawResponse = sendSoapRequest(command, soap, SOAPAction);
        var response = JSON.parse(x2j(rawResponse));

        if (typeof rawResponse !== 'string' || rawResponse.length == 0) {
            throw "Error in response. Request = " + soap + " Response = " + rawResponse;
        }

        var parsedJSON = extractObjectFromXML(response, 'Envelope.Body.GetSearchOptionsByGuidResponse.GetSearchOptionsByGuidResult');

        return {
            Type: entryTypes.note,
            Contents: parsedJSON,
            ContentsFormat: formats.json,
            ReadableContentsFormat: formats.markdown,
            EntryContext: { 'Archer.Content(true)': parsedJSON }
        };
    }

    function searchRecordsByReport(command, token, dataArgs) {

        var maxResults = dataArgs.maxResults || '1';
        var reportGuid = dataArgs.reportGuid;

        var soap = searchRecordsByReportSoapRequest(token, reportGuid, maxResults);
        var SOAPAction = 'http://archer-tech.com/webservices/SearchRecordsByReport';
        var rawResponse = sendSoapRequest(command, soap, SOAPAction);
        var response = JSON.parse(x2j(rawResponse));

        if (typeof rawResponse !== 'string' || rawResponse.length == 0) {
            throw "Error in response. Request = " + soap + " Response = " + rawResponse;
        }
        var parsedJSON = extractObjectFromXML(response, 'Envelope.Body.SearchRecordsByReportResponse.SearchRecordsByReportResult');

        return {
            Type: entryTypes.note,
            Contents: parsedJSON,
            ContentsFormat: formats.json,
            ReadableContentsFormat: formats.markdown,
            EntryContext: { 'Archer.Content(true)': parsedJSON }
        };
    }

    function getOccurredTime(recordTimeStr, tz) {
        var occurred = new Date();
        if (recordTimeStr) {
            var tzHour = tz / 60;
            if (tzHour < 0) {
                tzHour *= -1;
            }
            var tzMinute = tz % 60;
            var tzPrefix = tz < 0 ? '-' : '+';
            var tzHourstr = tzHour + '';
            if (tzHourstr.length < 2) {
                tzHourstr = '0' + tzHourstr;
            }
            var tzMinutestr = tzMinute +'';
            if (tzMinutestr.length < 2) {
                tzMinutestr = '0' + tzMinutestr;
            }

            // convert 7/18/2017 8:17:49 AM to 2017-07-18T20:17:49-0800
            var dateStr = recordTimeStr.split(' ')[0];
            var monthStr = dateStr.split('/')[0];
            var dayStr = dateStr.split('/')[1];
            var yearStr = dateStr.split('/')[2];

            var timeStr = recordTimeStr.split(' ')[1];
            var extStr = recordTimeStr.split(' ')[2];
            var hourInt = Number(timeStr.split(':')[0]);
            var minStr = timeStr.split(':')[1];
            var secStr = timeStr.split(':')[2];

            if (extStr == "PM" && hourInt < 12) {
                hourInt = hourInt + 12;
            }

            if (extStr == "AM" && hourInt == 12) {
                hourInt = hourInt - 12;
            }

            var hourStr = hourInt + '';
            if (Number(hourInt) < 10 && hourStr.length === 1) {
                hourStr = "0" + hourStr;
            }

            if (Number(minStr) < 10 && minStr.length === 1) {
                minStr = "0" + minStr;
            }

            if (Number(dayStr) < 10 && dayStr.length === 1) {
                dayStr = "0" + dayStr;
            }

            if (Number(monthStr) < 10 && monthStr.length === 1) {
                monthStr = "0" + monthStr;
            }

            recordTimeStr = yearStr + '-' +  monthStr + '-' + dayStr + 'T' + hourStr + ':' + minStr + ':' + secStr;
            occurred = new Date(Date.parse(recordTimeStr + tzPrefix + tzHourstr + tzMinutestr));
        }

        return occurred;
    }

    function toDateArcherString(date) {
        var day = Number(date.getDate());
        var month = Number(date.getMonth()) + 1;
        var year = date.getFullYear();
        var hour = date.getHours();
        var minutes = date.getMinutes();
        var seconds = date.getSeconds();
        var ext = 'AM';
        var finalHour = hour;

        if (hour > 12) {
            ext = 'PM';
            finalHour = (hour - 12);
            if (finalHour == 12) {
                ext = 'AM';
            }
        } else if (hour < 12) {
            finalHour = hour;
            ext = 'AM';
        } else if (hour == 12) {
            ext = 'PM';
        }

        if (minutes < 10) {
            minutes = '0' + minutes;
        }

        if (seconds < 10) {
            seconds = '0' + seconds;
        }

        // format such: 7/22/2017 3:58 PM
        return month + '/' + day + '/' + year + ' ' + finalHour + ':' + minutes + ':' + seconds + ' ' + ext;
    }

    function fetchIncidents(token, dataArgs) {
        var myTimezone = new Date().getTimezoneOffset() * -1;
        var tz = params.timeZone ? parseInt(params.timeZone) : myTimezone;
        if (params.timeZone === '0') {
            tz = 0;
        }

        var cmd = commands.searchRecords;
        var incidentRes = [];
        var lastRun = getLastRun();

        var day = 60 * 1000 * 60 * 24;
        var lastTime = lastRun.lastTime;
        if (!lastRun.lastTime) {
            lastTime = new Date().getTime() - (day * 1);
        }
        var searchByField = params.fetchByField;
        dataArgs.applicationId = params.fetchApplicationId;
        dataArgs.dateOperator = 'GreaterThan';
        dataArgs.searchValue = toDateArcherString(new Date(lastTime));
        dataArgs.fieldToSearchOn = searchByField;
        dataArgs.fieldsToDisplay = params.fetchFields + ',' + searchByField;

        var incidents = [];
        var results = searchRecords(cmd, token, dataArgs);
        if (results && results.Contents && results.Contents.length > 0) {
            for (var i = 0; i < results.Contents.length; i++) {
                var res = results.Contents[i];
                var labels = [];

                var fields = Object.keys(res.Fields);
                if (fields) {
                    for (var j = 0; j < fields.length; j++) {
                        var fieldName = fields[j];
                        var fieldValue;
                        fieldValue = res.Fields[fieldName];
                        if (fieldName === "Record"){
                            continue;
                        }
                        if (fieldName === "Date Created") {
                            lastTime = getOccurredTime(fieldValue, tz);
                        }
                        labels.push({ 'type': fieldName, 'value': fieldValue });
                    }
                }

                var raw = JSON.stringify(res);

                incidents.push({
                    name: 'RSA Archer Incident: ' + res.Id,
                    labels: labels,
                    details: raw,
                    rawJSON: raw,
                    occurred: lastTime
                });
            }

            var offset = tz ? (60 * 1000 * new Date().getTimezoneOffset()) : 0;
            setLastRun({ lastTime: lastTime.getTime() + offset });
        }
        return (JSON.stringify(incidents));
    }

    function getAuthToken() {
        var soap = createUserSessionFromInstanceSoapRequest(params.instanceName,
                                                            params.credentials.identifier,
                                                            params.credentials.password);
        var SOAPAction = 'http://archer-tech.com/webservices/CreateUserSessionFromInstance';
        var rawResponse = sendSoapRequest('login', soap, SOAPAction);
        var response = JSON.parse(x2j(rawResponse));

        if (typeof rawResponse !== 'string' || rawResponse.length == 0) {
            throw "Login failed. Request = " + soap + " Response = " + rawResponse;
        }

        var token = dq(response, 'Envelope.Body.CreateUserSessionFromInstanceResponse.CreateUserSessionFromInstanceResult');
        return token;
    }

    function destroyAuthToken(token) {
        var soap = terminateSessionSoapRequest(token);
        var SOAPAction = 'http://archer-tech.com/webservices/TerminateSession';

        try {
            sendSoapRequest('logout', soap, SOAPAction);
        } catch(err) {
            if (err.indexOf('Invalid session token') > -1) {
                // it means the session token already expired so no need to be terminated
                return
            }

            throw err
        }
    }

    function reLogin(token){
        destroyAuthToken(token);
        return getAuthToken();
    }

    function test() {
        var isFetch = params.isFetch;
        if (isFetch && !params.fetchApplicationId) {
            throw 'If Fetch incidents is on, then Application Id must be passed';
        }
    }

    var token = null;
    try {
        token = getAuthToken();
        switch (command) {
            case 'test-module':
                test();
                return !!token ? 'ok' : 'not-ok';
            case commands.createRecord:
                return createRecord(command, token, args);
            case commands.valueListForField:
                return getValueObjectForFieldId(token, args);
            case commands.updateRecord:
                return updateRecord(command, token, args);
            case commands.deleteRecord:
                return deleteRecord(command, token, args);
            case commands.getRecord:
                return getRecord(command, token);
            case commands.searchApps:
                return getListOfApplications(command, token);
            case commands.searchRecords:
                return searchRecords(command, token , args);
            case commands.getAppFields:
                return getAppFields(token);
            case commands.fetchIncidents:
                return fetchIncidents(token, args);
            case commands.getReports:
                return getReports(command, token);
            case commands.executeStatisticSearchByReport:
                return executeStatisticSearchByReport(command, token, args);
            case commands.getSearchOptionsByGuid:
                return getSearchOptionsByGuid(command, token, args);
            case commands.searchRecordsByReport:
                return searchRecordsByReport(command, token, args);
            case 'fetch-incidents':
                return fetchIncidents(token, args);
            default:
                break;
        }
    }
    finally {
        destroyAuthToken(token);
    }
  type: javascript
  commands:
  - name: archer-create-record
    arguments:
    - name: applicationId
      required: true
      description: ID of the application to create record in
    - name: fieldsToValues
      required: true
      description: 'Record fields in JSON format: { Name1: Value1, Name2: Value2 }.
        Field name is case sensitive.'
    outputs:
    - contextPath: Archer.Content.Id
      description: Content Id
    - contextPath: Archer.Content.Fields
      description: Content property fields
    description: Creates a new content record in the given application.
  - name: archer-update-record
    arguments:
    - name: contentId
      required: true
      description: The Content (record) ID to update
    - name: applicationId
      required: true
      description: ID of the application to update record in
    - name: fieldsToValues
      required: true
      description: 'Record fields in JSON format: { Name1: Value1, Name2: Value2 }.
        Field name is case sensitive.'
    description: Updates existing content record in the given application.
  - name: archer-get-record
    arguments:
    - name: contentId
      required: true
      description: 'The Content (record) ID to get details for (for example: id=12345
        for INC-12345)'
    - name: applicationId
      required: true
      description: ID of the application to get record from
    outputs:
    - contextPath: Archer.Content.Id
      description: Content Id of the record
    - contextPath: Archer.Content.Fields
      description: Content property fields
    - contextPath: Archer.Content.Fields.Incident Status
      description: Incident Status
    - contextPath: Archer.Content.Fields.Record Status
      description: Record Status
    - contextPath: Archer.Content.Fields.Last Updated
      description: Last Updated
    - contextPath: Archer.Content.Fields.Days Open
      description: Days Open
    - contextPath: Archer.Content.Fields.Date Created
      description: Date Created
    - contextPath: Archer.Content.Fields.Title
      description: Title
    - contextPath: Archer.Content.Fields.Incident Summary
      description: Incident Summary
    - contextPath: Archer.Content.Fields.Threat Category
      description: Threat Category
    - contextPath: Archer.Content.Fields.Threat Valid
      description: Threat Valid
    description: Gets information about a content record in the given application.
  - name: archer-search-applications
    arguments:
    - name: findByName
      default: true
      description: Get application by name (leave empty to get all applications)
    - name: findById
      description: Get application by ID (leave empty to get all applications)
    outputs:
    - contextPath: Archer.Applications.Id
      description: Application Id
    - contextPath: Archer.Applications.Type
      description: Application Type
    - contextPath: Archer.Applications.Name
      description: Application Name
    - contextPath: Archer.Applications.Status
      description: Application Status
    - contextPath: Archer.Applications.Guid
      description: Unique Id of application
    description: Gets application details or list of all applications.
  - name: archer-search-records
    arguments:
    - name: applicationId
      required: true
      description: ID of the application to search records in
    - name: fieldsToDisplay
      description: 'Fields to present in the search results in array format (for example:
        "Title,Incident Summary")'
      isArray: true
    - name: maxResults
      description: Maximum results to return from the search (default is 100)
      defaultValue: "100"
    - name: searchValue
      description: Search value (leave empty to search for all)
    - name: fieldToSearchOn
      description: Name of field to search on (leave empty to search for all)
    - name: numericOperator
      auto: PREDEFINED
      predefined:
      - Equals
      - NotEqual
      - GreaterThan
      - LessThan
      description: Numeric search operator
    - name: dateOperator
      auto: PREDEFINED
      predefined:
      - Equals
      - DoesNotEqual
      - GreaterThan
      - LessThan
      description: Date search operator
    outputs:
    - contextPath: Archer.Content.Id
      description: Content Id
    - contextPath: Archer.Content.ApplicationId
      description: Application Id
    - contextPath: Archer.Content.Fields
      description: Content property fields
    description: Search for records inside the given application
  - name: archer-get-application-fields
    arguments:
    - name: applicationId
      required: true
      default: true
      description: ID of the application to search fields in
    description: Gets all application fields by application ID
  - name: archer-delete-record
    arguments:
    - name: applicationId
      required: true
      description: ID of the application to delete record in
    - name: contentId
      required: true
      description: The Content (record) ID to delete
    description: Delete existing content record in the given application.
  - name: archer-value-list-for-field
    arguments:
    - name: fieldID
      required: true
      description: ID of the field
    - name: applicationId
      required: true
      description: ID of the application to get field value from
    description: Returns mapping from list value name to list value id
  - name: archer-fetch-incidents
    arguments:
    - name: applicationId
      required: true
      default: true
      description: ID of the application to fetch records from
    description: Fetching incidents from Archer
  - name: archer-get-reports
    arguments: []
    description: Gets reports from Archer
  - name: archer-execute-statistic-search-by-report
    arguments:
    - name: reportGuid
      required: true
      description: The Guid of the report
    - name: maxResults
      defaultValue: "100"
    description: Performs statistic search by report Guid
  - name: archer-get-search-options-by-guid
    arguments:
    - name: reportGuid
      required: true
    description: 'Getting search criteria by report GUID '
  - name: archer-search-records-by-report
    arguments:
    - name: reportGuid
      required: true
    - name: maxResults
      defaultValue: "1"
    description: Search records by report Guid
  isfetch: true
  runonce: false
  releaseNotes: "--"
