commonfields:
  id: PhishTank
  version: -1
name: PhishTank
display: PhishTank
category: Threat Intelligence
image: data:image/png;base64,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
description: PhishTank is a free community site where anyone can submit, verify, track
  and share phishing data
configuration:
- display: Use system proxy settings
  name: proxy
  defaultvalue: "true"
  type: 8
  required: false
- display: Database refresh interval (hours)
  name: fetchIntervalHours
  defaultvalue: "1"
  type: 0
  required: false
script:
  script: |
    var listSource = 'http://data.phishtank.com/data/online-valid.csv';
    var listUpdateIntervalHours = 1;

    var isNumber = function(obj) {
        return (obj == parseFloat(obj) && obj > 0);
    }

    if (isNumber(params.fetchIntervalHours)) {
        listUpdateIntervalHours = params.fetchIntervalHours;
    }

    var getList = function() {
        var res = http(listSource,{Method: 'GET'},false,params.proxy);
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Request Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }
        console.log('LOADING');
        var list = res.Body.split("\n");

        var obj={};
        for (var i=0;i<list.length;i++) {
            var line = list[i].split(",");

            var url = removeLastSlash(line[1]);
            if (url) {
                obj[url] = {
                    phish_id: line[0],
                    submission_time: line[3],
                    verified: line[4],
                    verification_time: line[5],
                    online: line[6],
                    target: line[7]
                };
            }
        }

        return obj;
    };

    var reload = function() {
        var list = getList();
        var data={'list':list,'timestamp':new Date().getTime()};
        setIntegrationContext(data);
        return data;
    };

    var isReloadNeeded = function(data) {
        if (!data || !data.timestamp || !data.list) {
            return true;
        }
        now = new Date().getTime();
        if (data.timestamp < now-(3600*1000*listUpdateIntervalHours)) {
            return true;
        }
        return false;
    }

    var removeLastSlash=function(pUrl) {
        var url=pUrl;
        if (url) {
            if (url[url.length - 1] == '/') {
                url = url.substr(0,url.length - 1);
            }
        }
        return url;
    }
    var doURL = function(pUrl) {
        var data = getIntegrationContext();
        if (isReloadNeeded(data)) {
            data = reload();
        }
        var url = removeLastSlash(pUrl);
        var ec = {};
        var md = "### PhishTank Database - URL Query\n";

        if (data.list[url]) {

            var dbotScore = (data.list[url].verified === 'yes') ? 3 : 2;
            addMalicious(ec, outputPaths.url, {
                Data: args.url,
                Malicious: {Vendor: 'PhishTank', Description: 'Match found in PhishTank database'}
            });
            ec.DBotScore = {Indicator: args.url, Type: 'url', Vendor: 'PhishTank', Score: dbotScore};

            md += "#### Found matches for URL " + args.url + "\n";
            md += objToMd(data.list[url]);
            var phishTankURL = 'http://www.phishtank.com/phish_detail.php?phish_id=' + data.list[url].phish_id;
            md += 'Additional details at ['+phishTankURL+']('+phishTankURL+')\n';
        } else {
            md += "#### No matches for URL " + args.url + "\n";
        }
        var res = {'url':args.url, 'match': true};
        return {Type: entryTypes.note, Contents: res, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};
    };

    switch (command) {
        case 'test-module':
            if (!isNumber(params.fetchIntervalHours)) {
                throw 'PhishTank error: Please provide a numeric value (and bigger than 0) for Database refresh interval (hours)';
            }
            var list=getList();
            if (Object.keys(list).length === 0) {
                throw 'Error - could not fetch PhishTank database';
            }
            return 'ok';
        case 'url':
            return doURL(args.url);
        case 'phishtank-reload':
            data=reload();
            var md = "PhishTank Database reloaded\n";
            md += "Total **" + Object.keys(data.list).length + "** URLs loaded.\n";
            return({Type: entryTypes.note, Contents: {}, ContentsFormat: formats.json, HumanReadable: md});
        case 'phishtank-status':
            data=getIntegrationContext();
            var md = "PhishTank Database Status\n";
            if (!data || !data.list) {
                md += "Database not loaded.\n"
            } else {
                md += "Total **" + Object.keys(data.list).length + "** URLs loaded.\n";
                md += "Last load time **" + new Date(data.timestamp).toString() + "**\n";
            }
            return({Type: entryTypes.note, Contents: {}, ContentsFormat: formats.json, HumanReadable: md});
        default:
            throw 'PhishTank error: unknown command';
    }
  type: javascript
  commands:
  - name: url
    arguments:
    - name: url
      required: true
      default: true
      description: URL to check
    outputs:
    - contextPath: URL.Data
      description: Bad URLs found
    - contextPath: URL.Malicious.Vendor
      description: For malicious URLs, the vendor that made the decision
    - contextPath: URL.Malicious.Description
      description: For malicious URLs, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
    important:
    - contextPath: URL(val.Malicious)
      description: Malicious URLs
      related: ""
    description: Check URL Reputation
  - name: phishtank-reload
    arguments: []
    description: Reload PhishTank database
  - name: phishtank-status
    arguments: []
    description: Show PhishTank database status
