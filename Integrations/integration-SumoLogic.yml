commonfields:
  id: SumoLogic
  version: -1
name: SumoLogic
display: SumoLogic
category: Analytics & SIEM
image: data:image/png;base64,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
description: Cloud-based service for logs & metrics management
detaileddescription: |-
  Follow this guide to generate access keys: [https://help.sumologic.com/Manage/Security/Access_Keys](https://help.sumologic.com/Manage/Security/Access_Keys).
  For the URL argument, take a look here: [https://help.sumologic.com/APIs/01Collector_Management_API/Sumo_Logic_Endpoints](https://help.sumologic.com/APIs/01Collector_Management_API/Sumo_Logic_Endpoints)
configuration:
- display: SumoLogic URL, in the format https://api.us2.sumologic.com/api/. This is
    region specific.
  name: url
  defaultvalue: https://api.us2.sumologic.com/api/
  type: 0
  required: true
- display: API Version
  name: apiVersion
  defaultvalue: v1
  type: 0
  required: true
- display: The access ID - can be created under "Settings"
  name: accessID
  defaultvalue: ""
  type: 0
  required: true
- display: The access key - can be created under "Settings"
  name: accessKey
  defaultvalue: ""
  type: 4
  required: true
- display: Use system proxy settings
  name: useproxy
  defaultvalue: "true"
  type: 8
  required: false
- display: Allow self-signed SSL certificates
  name: insecure
  defaultvalue: "false"
  type: 8
  required: false
- display: Seconds to sleep between checking for results
  name: sleepBetweenChecks
  defaultvalue: "3"
  type: 0
  required: true
- display: Default limit for the number of records to retrieve
  name: limit
  defaultvalue: "100"
  type: 0
  required: true
- display: Fetch incidents
  name: isFetch
  defaultvalue: ""
  type: 8
  required: false
- display: Incident type
  name: incidentType
  defaultvalue: ""
  type: 13
  required: false
- display: Run this query to fetch new events as incidents
  name: fetchQuery
  defaultvalue: ""
  type: 0
  required: false
- display: Default max total wait for results
  name: maxTimeout
  defaultvalue: "600"
  type: 0
  required: false
script:
  script: |
    var server = params.url.replace(/[\/]+$/, '') + '/' + params.apiVersion + '/';

    var doReq = function(method, path, parameters, cookies) {
        var result = http(
            server + path + (method === 'GET' && parameters ? encodeToURLQuery(parameters) : ''),
            {
                Headers: {'Content-Type': ['application/json'], 'Accept': ['application/json']},
                Method: method,
                Body: method == 'POST' && parameters ? JSON.stringify(parameters) : '',
                Username: params.accessID,
                Password: params.accessKey,
                Cookies: cookies
            },
            params.insecure,
            params.useproxy
        );

        if (result.StatusCode < 200 || result.StatusCode > 299) {
            var errObj;
            try {
                errObj = JSON.parse(result.Body);
            } catch (ex) {
                // Ignore this - we will just throw the status code back
            }
            if (errObj) {
                throw 'Status: ' + result.StatusCode + '\nID: ' + errObj.id + '\nCode: ' + errObj.code + '\nMessage: ' + errObj.message;
            }
            throw 'Failed to perform request ' + path + ', request status code: ' + result.StatusCode;
        }
        if (result.Body === '') {
            throw 'No content received.';
        }
        var obj;
        try {
            obj = JSON.parse(result.Body);
        } catch (ex) {
            throw 'Error parsing reply - ' + result.Body + ' - ' + ex;
        }
        return {body: result.Body, obj: obj, statusCode: result.StatusCode, cookies: result.Cookies};
    };

    var search = function(query, from, to, limit, offset, timezone, maxTimeToWaitForResults, sleep) {
        var p = {query: query};
        if (from) {
            p.from = from;
        }
        if (to) {
            p.to = to;
        }
        if (timezone) {
            p.timeZone = timezone;
        }
        // Create the job
        var res = doReq('POST', 'search/jobs', p, null);
        try {
            var done = false;
            var stat;
            // Wait for results based on parameters
            for (var i=0; i<maxTimeToWaitForResults / sleep; i++) {
                wait(sleep);
                stat = doReq('GET', 'search/jobs/' + res.obj.id, null, res.cookies);
                if (stat.obj.state === 'DONE GATHERING RESULTS' || stat.obj.messageCount > (offset + 1) * limit) {
                    done = true;
                    break;
                }
                if (stat.obj.state === 'CANCELLED') {
                    throw 'Job ' + res.obj.id + ' was cancelled';
                }
            }
            if (done) {
                var results = {};
                if (stat.obj.messageCount > 0) {
                    var msg = doReq('GET', 'search/jobs/' + res.obj.id + '/messages', {offset: offset, limit: limit}, res.cookies);
                    results.messages = msg.obj.messages.map(function(m) {return m.map;});
                }
                if (stat.obj.recordCount > 0) {
                    var rec = doReq('GET', 'search/jobs/' + res.obj.id + '/records', {offset: offset, limit: limit}, res.cookies);
                    results.records = rec.obj.records.map(function(m) {return m.map;});
                }
                return results;
            }
            throw 'Timeout while waiting for job ' + res.obj.id;
        } finally {
            try {
                doReq('DELETE', 'search/jobs/' + res.obj.id, null, res.cookies);
            } catch (ex) {
                logInfo('SumoLogic error deleting job - ' + ex);
            }
        }
    };

    var a2i = function(v, d) {
        return v ? parseInt(v) : d;
    };

    switch (command) {
        // This is the call made when pressing the integration test button.
        case 'test-module':
            doReq('GET', 'collectors', {limit: '1'}, null);
            return 'ok';
        case 'fetch-incidents':
            if (!params.fetchQuery) {
                throw 'No fetch query defined, not doing SumoLogic fetch';
            }
            var now = (new Date()).getTime();
            var lastRun = getLastRun();
            if (!lastRun || !lastRun.time) {
                // First time, retrieve events from the last 10 min
                lastRun = {time: now - 10 * 60 * 1000};
            }
            var s = search(params.fetchQuery, lastRun.time, now, 100, 0, 'UTC', a2i(params.maxTimeout, 180), a2i(params.sleepBetweenChecks, 3));
            var incidents = [];
            if (s.messages) {
                for (var i=0; i<s.messages.length; i++) {
                    var incident = {name: 'Incident from SumoLogic ' + s.messages[i]._messageid,
                        details: s.messages[i]._raw, labels: [], rawJSON: JSON.stringify(s.messages[i])};
                    var props = Object.getOwnPropertyNames(s.messages[i]);
                    for (var j=0; j<props.length; j++) {
                        if (props[j] !== '_raw') {
                            incident.labels.push({type: props[j], value: s.messages[i][props[j]]});
                        }
                    }
                    incidents.push(incident);
                }
            }
            setLastRun({time: now});
            return JSON.stringify(incidents);
        case 'search':
            var s = search(args.query, args.from, args.to, a2i(args.limit, 100), a2i(args.offset, 0), args.timezone,
                a2i(args.maxTimeToWaitForResults, 10) * 60, a2i(params.sleepBetweenChecks, 3));
            var md = '';
            var ec = {};
            if (s.messages && s.messages.length > 0) {
                md = tableToMarkdown('Messages', s.messages) + '\n';
                ec.Search = {Messages: s.messages.length > 100 ? s.messages.slice(0, 100) : s.messages};
            }
            if (s.records && s.records.length > 0) {
                md += tableToMarkdown('Records', s.records);
                ec.Search = {Records: s.records.length > 100 ? s.records.slice(0, 100) : s.records};
            }
            if (!md) {
                md = 'No results found';
            }
            return {Type: entryTypes.note, Contents: s, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};
        default:
            return {Type: entryTypes.error, Contents: 'Unknown command - ' + command, ContentsFormat: formats.text};
    }
  type: javascript
  commands:
  - name: search
    arguments:
    - name: query
      required: true
      default: true
      description: The search query to execute
    - name: from
      required: true
      description: The ISO 8601 date of the time range to start the search (example
        - 2016-08-28T12:00:00). Can also be milliseconds since epoch.
    - name: to
      required: true
      description: The ISO 8601 date of the time range to end the search (example
        - 2016-08-28T12:00:00). Can also be milliseconds since epoch.
    - name: limit
      description: Max results returned from query, int - by default will be 100
      defaultValue: "100"
    - name: offset
      description: Return results starting at this offset. should be int - by default
        is 0
      defaultValue: "0"
    - name: timezone
      description: The time zone if from/to is not in milliseconds, default is UTC,  See
        this (https://en.wikipedia.org/wiki/List_of_tz_database_time_zones) article
        for a list of time zone codes.
      defaultValue: UTC
    - name: maxTimeToWaitForResults
      description: Max amount of minutes to wait for search to end, default is 10
        minutes
      defaultValue: "10"
    outputs:
    - contextPath: Search.Messages
      description: The array of raw message objects
    - contextPath: Search.Records
      description: The array of aggregate records
    description: Search SumoLogic for matching records to the given query
  isfetch: true
cangetsamples: true
releaseNotes: "Implementation of SumoLogic with fetch incidents"
