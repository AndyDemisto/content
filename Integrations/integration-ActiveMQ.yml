commonfields:
  id: ActiveMQ
  version: -1
name: ActiveMQ
display: ActiveMQ
category: Authentication
image: data:image/png;base64,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
detaileddescription: |-
  This integration uses ActiveMQ STOMP protocol, that must be enabled (usually port 61613 by default) in order to work.
  Fetch incidents is based on using Durable Topic Subscribers, in order to fetch messages, and convert to Demisto incidents.
configuration:
- display: Fetch incidents
  name: isFetch
  defaultvalue: ""
  type: 8
  required: false
- display: Incident type
  name: incidentType
  defaultvalue: ""
  type: 13
  required: false
- display: Server IP (e.g. 192.168.0.1)
  name: hostname
  defaultvalue: ""
  type: 0
  required: true
- display: Port
  name: port
  defaultvalue: "61613"
  type: 0
  required: false
- display: Username
  name: credentials
  defaultvalue: ""
  type: 9
  required: false
- display: Client ID
  name: client-id
  defaultvalue: Demisto
  type: 0
  required: false
- display: Subscription ID
  name: subscription-id
  defaultvalue: "1"
  type: 0
  required: false
- display: Topic Name
  name: topic-name
  defaultvalue: ""
  type: 0
  required: false
script:
  script: |+
    import stomp

    class MsgListener(stomp.ConnectionListener):
        def __init__(self):
            self.result_arr = []
            self.msg_ids = []

        def on_error(self, headers, message):
            demisto.results('received an error "%s"' % message)
        def on_message(self, headers, message):
            self.result_arr.append(message)
            self.msg_ids.append(headers['message-id'])


    def create_connection():
        hostname = demisto.params()['hostname']
        port = int(demisto.params()['port'])
        conn = stomp.Connection([(hostname, port)])
        return conn

    def connect(conn, client_id=None):
        conn.start()
        username = demisto.params()['credentials']['identifier']
        password = demisto.params()['credentials']['password']

        if client_id and len(client_id) > 0:
            conn.connect(username, password, wait=True, headers = {'client-id': client_id })
        else:
            conn.connect(username, password, wait=True)
        return conn

    client = 'Demisto'
    if demisto.get(demisto.params(),'client-id'):
        client = demisto.params()['client-id']
    conn = create_connection()

    # The command demisto.command() holds the command sent from the user.
    if demisto.command() == 'test-module':
        connect(conn)
        conn.disconnect()
        demisto.results('ok')
        sys.exit(0)
    if demisto.command() == 'activemq-send':
        connect(conn)
        txid = conn.begin()
        dest = demisto.args()['destination']
        body = demisto.args()['body']
        conn.send(dest, body, transaction=txid)
        conn.commit(txid)
        demisto.results('Msg sent to ActiveMQ destination: '+dest+' with transaction ID: '+txid)
        conn.disconnect()
        sys.exit(0)
    if demisto.command() == 'activemq-subscribe':
        listener = MsgListener()
        if client and len(client) > 0:
            conn.set_listener('Demisto', listener)
        subscription_id = demisto.args()['subscription-id']
        conn = connect(conn, client)
        topic_name = demisto.args()['topic-name']
        conn.subscribe('/topic/'+topic_name, subscription_id, ack='client-individual', headers = {'activemq.subscriptionName': client })
        time.sleep(1)
        demisto.results(len(listener.result_arr))
        for msg in listener.result_arr:
            demisto.results(msg)
        for msg_id in listener.msg_ids:
            conn.ack(msg_id, 1)
        conn.disconnect()
        sys.exit(0)
    if demisto.command() == 'fetch-incidents':
        #lastRun = demisto.getLastRun()
        subscription_id = demisto.params()['subscription-id']
        #demisto.debug('before ActiveMQ subscribe'+str(lastRun))
        listener = MsgListener()
        if client and len(client) > 0:
            conn.set_listener('Demisto', listener)
        conn = connect(conn, client)
        demisto.debug('in ActiveMQ subscribe')
        topic_name = demisto.params()['topic-name']
        conn.subscribe('/topic/'+topic_name, subscription_id, ack='client-individual', headers = {'activemq.subscriptionName': client })
        demisto.debug('ActiveMQ subscribed: '+str(subscription_id))

        incidents = []
        time.sleep(3)
        demisto.debug('in ActiveMQ len='+str(len(listener.result_arr)))
        for i in range(len(listener.result_arr)):
            msg = listener.result_arr[i]
            msg_id = listener.msg_ids[i]
            incidents.append({"Name":"ActiveMQ incident:"+msg_id,"rawJSON":msg, "details":msg})
        demisto.incidents(incidents)
        last_msg_id = ""
        for msg_id in listener.msg_ids:
            conn.ack(msg_id, subscription_id)
            last_msg_id = msg_id
        lastRun = {'subscribe': str(subscription_id)}
        if len(last_msg_id)>0:
            lastRun['last_msg_id'] = last_msg_id
        demisto.setLastRun(lastRun)
        conn.disconnect()
        sys.exit(0)
  type: python
  commands:
  - name: activemq-send
    arguments:
    - name: destination
      required: true
      description: the destination (such as a message queue - for example ‘/queue/test’
        - or a message topic)
    - name: body
      required: true
      description: the content of the message
    description: Send msg to topic or queue
  - name: activemq-subscribe
    arguments:
    - name: subscription-id
      required: true
      description: the identifier to uniquely identify the subscription
      defaultValue: "1"
    - name: topic-name
      required: true
      description: the topic to subscribe to
    description: 'subscribe and read messages from topic '
  dockerimage: demisto/stomp
  isfetch: true
  runonce: false
