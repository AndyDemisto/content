commonfields:
  id: ArcSight ESM
  version: -1
name: ArcSight ESM
display: ArcSight ESM
category: Analytics & SIEM
image: data:image/png;base64,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
description: ArcSight ESM SIEM by Micro Focus (Formerly HPE Software).
configuration:
- display: Server URL (e.g. https://192.168.0.1)
  name: server
  defaultvalue: ""
  type: 0
  required: true
- display: Port
  name: port
  defaultvalue: "8443"
  type: 0
  required: true
- display: Credentials
  name: credentials
  defaultvalue: ""
  type: 9
  required: true
- display: Import events as incidents
  name: importEvents
  defaultvalue: ""
  type: 8
  required: false
- display: Events query viewer ID
  name: viewerId
  defaultvalue: ""
  type: 0
  required: false
- display: Time field for query
  name: timeField
  defaultvalue: ""
  type: 0
  required: false
- display: Import cases as incidents
  name: importCases
  defaultvalue: ""
  type: 8
  required: false
- display: Do not validate server certificate (insecure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 0
  required: false
- display: Fetch incidents
  name: isFetch
  defaultvalue: ""
  type: 8
  required: false
- display: Incident type
  name: incidentType
  defaultvalue: ""
  type: 13
  required: false
script:
  script: |-
    var server = params.server.replace(/[\/]+$/, '') + ':' + params.port + '/';

    var sendRequest = function(url, args, login) {
        var res = http(
                server + url + encodeToURLQuery(args),
                {
                    Method: 'GET',
                    Headers: {'Content-Type': ['application/x-www-form-urlencoded']}
                },
                params.insecure,
                params.proxy
            );
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            if (!login) {
              sendRequest(pathDictionary.logout, {authToken: args.authToken});
            }
            throw 'Request to ArcSight ' + url + ' failed, request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
        }
        return res.Body;
    }

    var sendAndParse = function(url, args) {
      return JSON.parse(x2j(sendRequest(url, args)));
    }

    var pathDictionary = {
        login: 'www/core-service/rest/LoginService/login',
        logout: 'www/core-service/rest/LoginService/logout',
        'as-get-matrix-data': 'www/manager-service/rest/QueryViewerService/getMatrixData',
        'as-get-all-cases': 'www/manager-service/rest/CaseService/findAllIds',
        'as-get-case': 'www/manager-service/rest/CaseService/getResourceById',
        ActiveListService: 'www/manager-service/services/ActiveListService/'
    };

    function getToken() {
      var match = /<ns3:return>(.+)<\/ns3:return>/.exec(sendRequest(
              pathDictionary.login,
              {
                  login: params.credentials.identifier,
                  password: params.credentials.password
              },
              true));
      return match.length >= 2 && match[1];
    }

    function getCasesIncidents(lastRun) {
      var newIncidents = [];
      var existingIds = lastRun && lastRun.caseIds ? lastRun.caseIds : {};
      var response;
      try {
        response = sendAndParse(pathDictionary['as-get-all-cases'], args)['findAllIdsResponse']['return'];
      } catch (ex) {
        throw 'response to get all cases is not in the correct format';
      }

      if (!Array.isArray(response)) {
        response = [response];
      }
      for (var i = 0; i < response.length; i++) {
        if (!existingIds[response[i]]) {
          existingIds[response[i]] = true;
          args.resourceId = response[i];
          var data = sendAndParse(pathDictionary['as-get-case'], args)['getResourceByIdResponse']['return'];
          var keys = Object.keys(data);
          var labels = [];
          for (var j = 0; j<keys.length; j++) {
            if (keys[j] !== 'Name') {
              labels.push({'type': keys[j], 'value': String(data[keys[j]])});
            }
          }
          newIncidents.push({
            name: data.Name || ('New event from arcsight at ' + Date.now()),
            labels: labels,
            rawJSON: JSON.stringify(data[i]).replace(/\\"/g, '"'),
          });
          delete(args.resourceId);
        }
      }
      lastRun.caseIds = existingIds;
      return newIncidents;
    }

    function convertRowsToStruct(fields, rows) {
      var data = [];
      for (var i = 0; i < rows.length; i++) {
        var newData = {};
        for (var j = 0; j < fields.length; j++) {
          if (rows[i].value[j]['#text']) {
            newData[fields[j]] = rows[i].value[j]['#text'];
          }
        }
        data.push(newData);
      }
      return data;
    }

    var getEventsIncidents = function(lastRun) {
      var newIncidents = [];
      args.id = params.viewerId;
      var response;
      try {
        response = sendAndParse(pathDictionary['as-get-matrix-data'], args)['getMatrixDataResponse']['return'];
      } catch (ex) {
        throw 'response to query is not in the correct format';
      }
      if (!response) {
        throw 'response to query is empty';
      }
      var fieldNames = response['columnHeaders'];
      if (fieldNames.indexOf(params.timeField) === -1) {
        throw 'time field is missing in query response';
      }
      var data = convertRowsToStruct(fieldNames, response['rows']);
      var lastEventTime = lastRun && lastRun.lastEventTime ? lastRun.lastEventTime : 0;
      for (var i = 0; i < data.length; i++) {
        if (lastEventTime < data[i][params.timeField]) {
          lastRun['lastEventTime'] = data[i][params.timeField];
          var keys = Object.keys(data[i]);
          var labels = [];
          for (var j = 0; j<keys.length; j++) {
            if (keys[j] !== 'Name') {
              labels.push({'type': keys[j], 'value': String(data[i][keys[j]])});
            }
          }
          newIncidents.push({
            name: data[i].Name || ('New event from arcsight at ' + Date.now()),
            labels: labels,
            rawJSON: JSON.stringify(data[i]).replace(/\\"/g, '"'),
          });
        }
      }

      delete(args.id);
      return newIncidents;
    }

    args.authToken = getToken();

    // convertCsvToEntryListObject converts entries which is array of entry objects into entryList object according to the SOAP request
    // entryList object contains separately the columns and the entries
    function convertCsvToEntryListObject(entries) {
      var entryList = [];
      var columns = [];

      if (!entries || !Array.isArray(entries) || entries.length === 0) {
        return { columns: [], entryList: [] };
      }

      // extract the columns
      for (var column in entries[0]) {
        if (entries[0].hasOwnProperty(column)) {
          columns.push(column);
        }
      }

      // get the entries
      for (var i = 0; i < entries.length; i++) {
        entryRow = [];
        for (var j = 0; j < columns.length; j++) {
          var column = columns[j];
          var innerEntryValue = entries[i][column];
          entryRow.push(innerEntryValue);
        }
        entryList.push(entryRow);
      }


      return { columns: columns, entryList: entryList }
    }

    function convertFromEntryListToCsvJSON(entryList) {
        var columns = entryList.return.columns;
        var entries = entryList.return.entryList;

        var entriesArray = [];
        for (var i = 0; i < entries.length; i++) {
            var newEntry = {};
            for (var columnIdx = 0; columnIdx < columns.length; columnIdx++) {
                var column = columns[columnIdx];
                // log(column)
                var innerEntry = entries[i].entry[columnIdx];
                newEntry[column] = innerEntry;
            }

            entriesArray.push(newEntry);
        }

        return entriesArray;
    }

    var addEntriesTemplate = '<?xml version="1.0" encoding="UTF-8"?><soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:act="http://ws.v1.service.resource.manager.product.arcsight.com/activeListService/" xmlns:xsd="http://activelist.model.v1.service.resource.manager.product.arcsight.com/xsd"><soapenv:Header /><soapenv:Body><act:addEntries><act:authToken>%authToken%</act:authToken><act:resourceId>%resourceId%</act:resourceId><act:entryList>%entryList%</act:entryList></act:addEntries></soapenv:Body></soapenv:Envelope>';
    function addEntries() {
        var entryList = convertCsvToEntryListObject(args.entries)
        var stringBuilder = [];
        entryList.columns.forEach(function(column) {
          stringBuilder.push(replaceInTemplates('<columns>%column%</columns>', { column: column }));
        })
        entryList.entryList.forEach(function(entryRow) {
            stringBuilder.push('<entryList>');
            entryRow.forEach(function(entry) {
                stringBuilder.push(replaceInTemplates('<entry>%entry%</entry>', { entry: entry }));
            })
            stringBuilder.push('</entryList>');
        })

        var entryListXml = stringBuilder.join('');
        var soapReq = replaceInTemplates(addEntriesTemplate, { authToken: args.authToken, resourceId: args.resourceId, entryList: entryListXml });
        sendSOAPRequest('www/manager-service/services/ActiveListService/', null, soapReq);
        return 'Success';
    }

    var clearEntriesTemplate = '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:act="http://ws.v1.service.resource.manager.product.arcsight.com/activeListService/"><soapenv:Header/><soapenv:Body><act:clearEntries><act:authToken>%authToken%</act:authToken><act:resourceId>%resourceId%</act:resourceId></act:clearEntries></soapenv:Body></soapenv:Envelope>';
    function clearEntries() {
        var soapReq = replaceInTemplates(clearEntriesTemplate, { authToken: args.authToken, resourceId: args.resourceId });
        var res = sendSOAPRequest('www/manager-service/services/ActiveListService/', null, soapReq);
        return 'Success';
    }

    var getEntriesTemplate = '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:act="http://ws.v1.service.resource.manager.product.arcsight.com/activeListService/"><soapenv:Header/><soapenv:Body><act:getEntries><act:authToken>%authToken%</act:authToken><act:resourceId>%resourceId%</act:resourceId></act:getEntries></soapenv:Body></soapenv:Envelope>';
    function getEntries() {
        var soapReq = replaceInTemplates(getEntriesTemplate, { authToken: args.authToken, resourceId: args.resourceId });
        var res = sendSOAPRequest('www/manager-service/services/ActiveListService/', null, soapReq);

        var entryArray = convertFromEntryListToCsvJSON(parseSOAPResponse(res.Body));
        if (args.entryFilter) {
            var filteredEntries = [];
            var conditions = args.entryFilter.split(':');
            var conditionKey = conditions[0]; // moo
            var conditionValue = conditions[1]; // moo1

            for (var i = 0; i < entryArray.length; i++) {
                var entry = entryArray[i];

                if (entry[conditionKey] === conditionValue) {
                    filteredEntries.push(entry);
                }
            }
            entryArray = filteredEntries;
        }
        return {
          Type: entryTypes.note,
          ContentsFormat: formats.json,
          Contents: { result: entryArray },
          ReadableContentsFormat: formats.markdown,
          HumanReadable: tableToMarkdown('Active List ' + args.resourceId, entryArray)
        };
    }
    function sendSOAPRequest(queryPath, param, body) {
        // prepare the request url (make sure to encode the query parameter value)
        var requestUrl = server + queryPath;
        if (param) {
            requestUrl += encodeToURLQuery(param);
        }
        //throw body;
        var res = http(
            requestUrl,
            {
                Method: 'POST',
                Body: body
            },
            params.insecure,
            params.useproxy
        );

        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Request Failed to ' + requestUrl + '.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }

        return res;
    }

    function parseSOAPResponse(resBody) {
      var matches = resBody.match('<ns.:return>(.|[\r\n])*<\/ns.:return>');
      if (!matches) {
        return null;
      }

      var match = matches[0];
      var json = JSON.parse(x2j(match));
      return json;
    }

    switch (command) {
      case 'test-module':
        sendRequest(pathDictionary.logout, args);
        return 'ok';
      case 'fetch-incidents':
        var lastRun = getLastRun();
        lastRun = lastRun && lastRun.value ? JSON.parse(lastRun.value) : {};
        var casesIncidents = [];
        var eventsIncidents = [];
        if (params.importCases) {
          casesIncidents = getCasesIncidents(lastRun);
        }
        if (params.importEvents) {
          eventsIncidents = getEventsIncidents(lastRun);
        }
        setLastRun({value: JSON.stringify(lastRun)});
        return JSON.stringify(casesIncidents.concat(eventsIncidents));
      case 'as-add-entries':
          return addEntries();
      case 'as-clear-entries':
          return clearEntries();
      case 'as-get-entries':
          return getEntries();
      default:
        return sendAndParse(pathDictionary[command], args);
    }
  type: javascript
  commands:
  - name: as-get-all-cases
    arguments: []
    description: commands.server.arcsight.getallcases.description
  - name: as-get-case
    arguments:
    - name: resourceId
      required: true
      default: true
      description: commands.server.arcsight.arguments.caseid.description
    description: commands.server.arcsight.getspecificcase.description
  - name: as-get-matrix-data
    arguments:
    - name: id
      required: true
      default: true
      description: commands.server.arcsight.arguments.queryid.description
    description: commands.server.arcsight.query.description
  - name: as-add-entries
    description: Import/add new entries to Active List. 
    arguments:
    - name: resourceId
      required: true
      description: Resource id of specific Active List
    - name: entries
      required: true
      description: 'Entries must be a json, array that contains objects. Every object must have fields with the exact names as the Active List columns. For example: Active list - Black List IPs has 2 columns (count, ip_addr), then the entries can like following: [{"count":0,"ip_addr":"1.1.1.1"},{"count":4,"ip_addr":"2.2.2.2"}]'
      isArray: true
    execution: true
  - name: as-clear-entries
    description: Deletes all the entries in the Active List
    arguments:
    - name: resourceId
      description: Resource id of specific Active List
      required: true
    execution: true
  - name: as-get-entries
    description: Returns the entries which the Active List contains
    arguments:
    - name: resourceId
      description: Resource id of specific Active List
      required: true
    - name: entryFilter
      description: 'OPTIONAL. Filters the entries. Example: entryFilter="moo:moo1"'
  isfetch: true
hidden: false
releaseNotes: added description to missing commands
