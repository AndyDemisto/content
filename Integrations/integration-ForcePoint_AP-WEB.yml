commonfields:
  id: TRITON AP-WEB
  version: -1
name: TRITON AP-WEB
display: TRITON AP-WEB
category: Network Security
image: data:image/png;base64,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
configuration:
- display: 'URL of Forcepoint WEB API. Example: https://<IP>:15873/'
  name: url
  defaultvalue: ""
  type: 0
  required: true
- display: Credentials
  name: credentials
  defaultvalue: ""
  type: 9
  required: true
- display: Use system proxy settings
  name: proxy
  defaultvalue: "True"
  type: 8
  required: false
script:
  script: |
    var usr = params.credentials.identifier;
    var pass = params.credentials.password;

    var sendRequest = function(method, body, action){
        headers = {
            'Accept': ['application/json'],
            'Content-Type': ['application/json']
        };

        url = params.url+"/api/web/v1/categories/"+action;
        res = http(url,{Method: method,Headers: headers,Body: body, Username: usr, Password: pass},true,params.proxy);
        return JSON.parse(res.Body);
    };

    var getTansId = function(){
        res = sendRequest("POST", "", "start");

        try {
            tran_id = res["Transaction ID"];
        } catch (ex) {
            throw "Error getting Transaction ID";
        }
    };

    var commit = function(){
        return sendRequest("POST", "", "commit?transactionid="+tran_id);
    };

    var status = function(){
        var body = {};
        var res = sendRequest("GET", JSON.stringify(body), "status");

        var md = "";
        for(var i = 0; i<res["Status"]; i++){
            md += res["Status"][i]+"\n";
        }

        return ( {'ContentsFormat': formats['json'], 'Type': entryTypes['note'], 'Contents': res, "HumanReadable": md, "EntryContext": {}} );
    };

    var addCategory = function(){
        var body = {};

        body["Transaction ID"] = getTansId();
        var categories = [];
        categories.push({
            "Category Name": args["category-name"],
            "Category Description" : args["category-description"],
            "Parent": parseInt(args["parent"])
        });
        body.Categories = categories;
        var res = sendRequest("POST", JSON.stringify(body), "");
        commit();

        var md = "Category "+res["Categories"][0]["Category Name"]+" added";

        return ( {'ContentsFormat': formats['json'], 'Type': entryTypes['note'], 'Contents': res, "HumanReadable": md, "EntryContext": {}} );
    };

    var deleteCategory = function(){
        var body = {};

        body["Transaction ID"] = getTansId();
        if(args["ids"]){
            body["Category IDs"] = args["ids"].split(',');
        }

        if(args["names"]){
            body["Category Names"] = args["names"].split(',');
        }

        res = sendRequest("DELETE", JSON.stringify(body), "");
        commit();
        if (res["StatusCode"] !== 200){
            return ("Error "+JSON.stringify(res));
        }else{

            var md = "Successfully deleted the categories. Please run status command for further details";

            return ( {'ContentsFormat': formats['json'], 'Type': entryTypes['note'], 'Contents': res, "HumanReadable": md, "EntryContext": {}} );
        }
    }

    var addIps = function(){
        var body = {};

        body["Transaction ID"] = getTansId();

        if(args["category-name"]){
            body["Category Name"] = args["category-name"];
            }

        if(args["category-id"]){
            body["Category ID"] = parseInt(args["category-id"]);
        }

        if (args["urls"]) {
            body.URLs = args["urls"].split(',');
        }

        if (args["ips"]) {
            body.IPs = args["ips"].split(',');
        }

        var res = sendRequest("POST", JSON.stringify(body), "urls");
        commit();

        var md = "### "+res["Category Name"];
        md += "You added "+res["Totals"]["Added URLs"]+" urls and "+res["Totals"]["Added IPs"]+" IPs to the category "+res["Category Name"]

        return ( {'ContentsFormat': formats['json'], 'Type': entryTypes['note'], 'Contents': res, "HumanReadable": md, "EntryContext": {}} );
    };

    var printSubCategories = function(res){
        var md = "";

        for(var i=0; i<res.length; i++){
            md += "\tCategory Name: "+res[i]["Category Name"]+"\n";
            md += "\tCategory ID:"+res[i]["Category ID"]+"\n";
            md += "\tCategory Description: "+res[i]["Category Description"]+"\n";
            if(res[i]["Children"] !== undefined){
                md += "Children:\n"+"\t"+printSubCategories(res[i]["Children"],depth+1);
            }
            md += "\n==============\n";
        }

        return md;
    }
    var listCategories = function(){
        var body = {};
        var res = "";

        res = sendRequest("GET", JSON.stringify(body), (args["master"] == 'true') ? "all" : "");

        var ec = {"Categories":[]};
        var md = "";
        for(var i=0; i<res["Categories"].length; i++){
            ec["Categories"].push({"Category name":res["Categories"][i]["Category Name"],
                "Category id":res["Categories"][i]["Category ID"],
                "Category description":res["Categories"][i]["Category Description"]
            });
            md += "Category Name: "+res["Categories"][i]["Category Name"]+"\n";
            md += "Category ID: "+res["Categories"][i]["Category ID"]+"\n";
            md += "Category Description: "+res["Categories"][i]["Category Description"]+"\n";
            if (res["Categories"][i]["Children"] != undefined){
                md += "Children:\n"+"\t"+printSubCategories(res["Categories"][i]["Children"],1);
            }
            md += "\n==============\n"
        }


        return ( {'ContentsFormat': formats['json'], 'Type': entryTypes['note'], 'Contents': res, "HumanReadable": md, "EntryContext": ec} );
    }

    var listIps = function(){
        var body = {};
        var res;

        if(args["category-name"]){
            res = sendRequest("GET", JSON.stringify(body), "urls?catname="+args["category-name"]);
        }

        if(args["category-id"]){
            res = sendRequest("GET", JSON.stringify(body), "urls?catid="+args["category-id"]);
        }

        var md = " ### Category Name: "+ res["Category Name"]+"\n";

        md += "URLs\n";
        ec = {"FP Category":{"Category Name":args["category-name"], "IPS":[], "URLS":[]}};

        for (var i = 0; i<res["URLs"].length; i++){
            md += res["URLs"][i]+"\n";
            ec["FP Category"]["URLS"].push(res["URLs"][i]);
        }

        md += "IPs\n";

        for (var i = 0; i<res["IPs"].length; i++){
            md += res["IPs"][i]+"\n";
            ec["FP Category"]["IPS"].push(res["IPs"][i]);
        }

        return ( {'ContentsFormat': formats['json'], 'Type': entryTypes['note'], 'Contents': res, "HumanReadable": md, "EntryContext": ec} );
    }

    var deleteIps = function(){
        var body = {};

        body["Transaction ID"] = getTansId();

        if(args["category-name"]){
            body["Category Name"] = args["category-name"];
        }

        if(args["category-id"]){
            body["Category ID"] = parseInt(args["category-id"]);
        }

        if (args["urls"]) {
            body.URLs = args["urls"].split(',');
        }

        if (args["ips"]) {
            body.IPs = args["ips"].split(',');
        }

        var res = sendRequest("DELETE", JSON.stringify(body), "urls");
        commit();

        var md = "You deleted "+res["Totals"]["Added URLs"]+" urls and "+res["Totals"]["Added IPs"]+" IPs from the category "+res["Category Name"]

        return ( {'ContentsFormat': formats['json'], 'Type': entryTypes['note'], 'Contents': res, "HumanReadable": md, "EntryContext": {}} );
    }

    switch (command) {
        case 'forcepoint-add-category':
            return addCategory();

        case 'forcepoint-delete-categories':
            return deleteCategory();

        case "forcepoint-add-ips":
            return addIps();

        case "forcepoint-list-categories":
            return listCategories();

        case "forcepoint-list-ips":
            return listIps();

        case "forcepoint-delete-ips":
            return deleteIps();

        case "forcepoint-status":
            return status();

        case 'test-module':
            headers = {
                'Accept': ['application/json'],
                'Content-Type': ['application/json']
            };

            body = "";
            url = params.url+"/api/web/v1/categories/start";
            res = http(url,{Method: "POST",Headers: headers,Body: body, Username: usr, Password: pass},true);
            if (res.StatusCode != 200) {
                return JSON.stringify(res);
            }else {
                return 'ok';
            }

        default:
            throw 'ForcePoint unknown command';
    }
  type: javascript
  commands:
  - name: forcepoint-add-category
    arguments:
    - name: category-name
      required: true
      default: true
      description: Category name
    - name: category-description
      description: Description
    - name: parent
      required: true
      description: ID of the parent category(Default is 0)
      defaultValue: "0"
    description: Add new category to Forcepoint Web
  - name: forcepoint-add-ips
    arguments:
    - name: urls
      description: List of URLs separated by comma
      isArray: true
    - name: ips
      description: List of IPs separated by comma
      isArray: true
    - name: category-name
      default: true
      description: Category name
    - name: category-id
      description: Category ID
    description: Add IPs or URLs to existing category
  - name: forcepoint-delete-categories
    arguments:
    - name: ids
      description: Categories IDs
    - name: names
      default: true
      description: Categories names
    description: Delete categories from Forcepoint WEB
    execution: true
  - name: forcepoint-delete-ips
    arguments:
    - name: category-id
      description: Category ID
    - name: category-name
      default: true
      description: Category name
    - name: ips
      description: List of IPs separated by comma
    - name: urls
      description: List of URLs separated by comma
    description: Delete IPs or URLs from specific category
    execution: true
  - name: forcepoint-list-categories
    arguments:
    - name: master
      required: true
      auto: PREDEFINED
      predefined:
      - "false"
      - "true"
      description: Do show Forcepoint defined master database categories
      defaultValue: "false"
    description: Show all categories
  - name: forcepoint-list-ips
    arguments:
    - name: category-id
      description: Category ID
    - name: category-name
      default: true
      description: Category name
    description: List IPs and URLs for specific category
  - name: forcepoint-status
    arguments: []
    description: Show status of the Forcepoint WEB API
hidden: false
