commonfields:
  id: Tenable Security Center
  version: -1
name: Tenable Security Center
display: Tenable Security Center
category: Authentication
image: data:image/png;base64,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
configuration:
- display: Server address
  name: server
  defaultvalue: https://tenablesc.eastus.cloudapp.azure.com/rest
  type: 0
  required: true
- display: Credentials
  name: credentials
  defaultvalue: ""
  type: 9
  required: true
- display: Do not validate certificate (insecure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
script:
  script: |
    var SERVER_URL = params.server;
    var TOKEN;
    var TNS_SESSION_ID_COOKIE;
    if (SERVER_URL[SERVER_URL.length - 1] !== '/') {
        SERVER_URL = SERVER_URL.concat('/');
    }

    function getHeaders(token){
        var headers = {};
        headers['Accept'] = ['application/json'];
        headers['Content-Type'] = ['application/json'];
        if(token){
            headers['X-SecurityCenter'] =  [token.toString()];
            headers['Cookie'] = [TNS_SESSION_ID_COOKIE];
        }

        return headers;
    }


    function getCookieFromResponse(response){
        var cookieHeader = response.Headers['Set-Cookie'];
        if(!(cookieHeader instanceof Array)) {
            cookieHeader = [cookieHeader];
        }
        var cookies = cookieHeader[cookieHeader.length - 1];

        // Gets the TNS_SESSION_ID part of the cookie
        return cookies.split(';')[0];
    }

    function login(userName, password) {
        var loginBody = { username: userName, password: password };
        var loginResponse = sendLoginRequest(JSON.stringify(loginBody));
        var token = loginResponse.response.token;
        // There might be a case where the API does not return a token because there are too many sessions with the same user.
        // In that case we need to add 'releaseSession = true';
        if(!token) {
            loginBody.releaseSession = "true";
            loginResponse = sendLoginRequest(JSON.stringify(loginBody));
            token = loginResponse.response.token;
        }

        TOKEN = token;

    }

    function sendLoginRequest(loginBody){
        var requestUrl = SERVER_URL.concat('token');
        var result = http(
            requestUrl,
            {
                Headers: getHeaders(),
                Method: 'POST',
                Body: loginBody
            },
            params.insecure
        );

        if(result.StatusCode < 200 || result.StatusCode >= 300){
            throw 'Request failed!\nStatus code:' + result.StatusCode + '.\nBody: ' + JSON.stringify(result) + '.';
        }

        TNS_SESSION_ID_COOKIE = getCookieFromResponse(result);

        return JSON.parse(result.Body);
    }

    function logout() {
        sendRequest('token', 'DELETE');
    }

    function sendRequest(path, method, queryParams, body){
        var requestUrl = SERVER_URL.concat(path, queryParams ? encodeToURLQuery(queryParams ) : '');
        var result = http(
            requestUrl,
            {
                Headers: getHeaders(TOKEN),
                Method: method,
                Body: body
            },
            params.insecure
        );

        if(result.StatusCode < 200 || result.StatusCode >= 300){
            throw 'Request failed!\nStatus code:' + result.StatusCode + '.\nBody: ' + JSON.stringify(result) + '.';
        }

        return JSON.parse(result.Body);
    }

    function getRepositories() {
        var repositories = getRepositoriesRequest();
        var ec = {
            Repositories : repositories
        };

        return {
            Type: entryTypes.note,
            Contents: repositories,
            ContentsFormat: formats.json,
            HumanReadable: tableToMarkdown('Available repositories', repositories, ['id', 'name', 'description']),
            EntryContext: ec
        };
    }

    function getRepositoriesRequest() {
        var result = sendRequest('repository', 'GET');
        var repositories = result.response;
        return repositories;
    }

    function getTickets(){
        var tickets = getTicketsRequest();

        return{
            Type: entryTypes.note,
            Contents: tickets,
            ContentsFormat: formats.json,
            HumanReadable: tableToMarkdown('Available tickets', tickets, Object.keys(tickets)),
            EntryContext: ec
        };
    }

    function getTicketsRequest() {
        var result = sendRequest('ticket', 'GET');
        var tickets = result.response;

        return tickets;
    }

    login(params.credentials.identifier, params.credentials.password);
    var resultEntry;
    switch (command) {
        // This is the call made when pressing the integration test button.
        case 'test-module':
            // logout();
            return TOKEN ? 'ok' : 'notok';
        case 'fetch-incidents':
            // JSON of the incident type created by this integration
            // You can store the last run as a string using set last run.
            setLastRun({'time': 'now'});
            // And you can retrieve it in any other call...
            var now = getLastRun();
            // now is an object with field time, that has value 'now'.
            return JSON.stringify([{"Name":"Incident #1"},{"Name":"Incident #2"}]);
        case 'tsc-repositories':
            try{
                resultEntry = getRepositories();
            }
            catch(e) {
                throw "Could not get repositories, error: " + e;
            }
            finally {
                logout();
            }
            break;
        case 'tsc-tickets':
            try{
                resultEntry = getTickets();
            }
            catch(e){
                throw "Could not get tickets, error: " + e;
            }
            finally {
                logout();
            }
            break;
        default:
        // You can use args[argName] or args.argName to get a specific arg. args are strings.
        // You can use params[paramName] or params.paramName to get a specific params.
        // Params are of the type given in the integration page creation.
    }

    return resultEntry;
  type: javascript
  commands:
  - name: tsc-repositories
    arguments: []
    description: List of repositories
  - name: tsc-tickets
    arguments: []
    description: List of tickets
  runonce: false
