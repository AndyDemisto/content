commonfields:
  id: Mimecast Authentication
  version: -1
name: Mimecast Authentication
display: Mimecast Authentication
category: Authentication & Messaging
image: data:image/png;base64,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
description: Creates Access Key and  Secret Key for Mimecast API
detaileddescription: This is strictly to manage (create/refresh/discover)  Mimecast
  API Access Keys and  Secret Keys
configuration:
- display: BaseUrl
  name: baseUrl
  defaultvalue: https://api.mimecast.com
  type: 0
  required: true
- display: User Email Address
  name: emailAddress
  defaultvalue: ""
  type: 0
  required: true
- display: Password
  name: password
  defaultvalue: ""
  type: 4
  required: true
- display: BasicCloudAuth (if false will use Basic-Ad- domain auth)
  name: basicCloudAuth
  defaultvalue: "true"
  type: 8
  required: false
- display: insecure
  name: insecure
  defaultvalue: "true"
  type: 8
  required: false
script:
  script: |-
    var authType = params.basicCloudAuth ? 'Basic-Cloud' : 'Basic-Ad';

    var baseUrl = params.baseUrl;

    var insecure = params.insecure;

    var demistoAppId = 'dc04611d-3315-4572-976a-a2a9ddc7a0b9';

    var sendRequest = function(method, url, body) {
            var auth = basicAuth(params.emailAddress,params.password);
            auth = auth.substring(6); // cut the "basic " prefix
            var authHeader = authType+' '+auth;
            var res = http(
                    url,
                    {
                        Method: method,
                        Body: body,
                        Headers: {'Authorization': [authHeader], 'x-mc-app-id': [demistoAppId]},
                    },
                    insecure
                );
            if (res.StatusCode < 200 || res.StatusCode >= 300) {
                throw 'Failed to use url ' + url + ', request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
            }
            return JSON.parse(res.Body);
    };

    var login = function() {
            var body = {};
            var l = {};
            l.userName = params.emailAddress;
            body.data = [l];
            bodyAsString = JSON.stringify(body);
            return sendRequest('POST', baseUrl + '/api/login/login', bodyAsString);
    };

    var refresh = function(accessKey) {
            var body = {};
            var data = {};
            data.userName = params.emailAddress;
            data.accessKey = accessKey;
            body.data = [data];
            bodyAsString = JSON.stringify(body);
            return sendRequest('POST', baseUrl + '/api/login/login', bodyAsString);
    };

    var logout = function(accessKey) {
            var body = {};
            var data = {};
            data.accessKey = accessKey;
            body.data = [data];
            bodyAsString = JSON.stringify(body);
            return sendRequest('POST', baseUrl + '/api/login/logout', bodyAsString);
    };

    var discover = function() {
            var body = {};
            var d = {};
            d.emailAddress = params.emailAddress;
            body.data = [d];
            bodyAsString = JSON.stringify(body);
            var res = http(
                    baseUrl+'/api/login/discover-authentication',
                    {
                        Method: 'POST',
                        Body: bodyAsString,
                        Headers: {'x-mc-app-id': [demistoAppId]}
                    },
                    insecure
                );
            if (res.StatusCode < 200 || res.StatusCode >= 300) {
                throw 'Failed to use url ' + url + ', request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
            }
            return JSON.parse(res.Body);
    };

    switch (command) {
        case 'test-module':
            discover();
            return 'ok';
        case 'mimecast-login':
            return login();
        case 'mimecast-logout':
            return logout(args.accessKey);
        case 'mimecast-discover':
            return discover();
        case 'mimecast-refresh-token':
            return refresh(args.accessKey);
        default:
    }
  type: javascript
  commands:
  - name: mimecast-login
    arguments: []
    description: login to generate Access Key and  Secret Key
  - name: mimecast-discover
    arguments: []
    description: 'discover authentication types are supported for your account and
      which base URL to use for the requesting user. '
  - name: mimecast-refresh-token
    arguments:
    - name: accessKey
      required: true
      default: true
      description: A valid Access Key
    description: refresh Access Key valid time
