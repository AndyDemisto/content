commonfields:
  id: Lastline
  version: -1
name: Lastline
display: Lastline
category: Data Enrichment
image: data:image/png;base64,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
description: Submitting resources for analysis and obtaining the results
configuration:
- display: Server URL (e.g. https://user.lastline.com)
  name: url
  defaultvalue: http://user.lastline.com
  type: 0
  required: true
- display: API Key for accessing Lastline APIs
  name: api_key
  defaultvalue: ""
  type: 0
  required: true
- display: API Token for accessing Lastline APIs
  name: api_token
  defaultvalue: ""
  type: 4
  required: true
- display: Use system proxy settings
  name: proxy
  defaultvalue: "True"
  type: 8
  required: false
- display: Score threshold for marking file or URL as malicious
  name: malicious_score
  defaultvalue: "50"
  type: 0
  required: false
- display: Score threshold to present analysis in war room
  name: full_report_score
  defaultvalue: "50"
  type: 0
  required: false
script:
  script: |+
    var lastlineDefaults = {interval:10, timeout:60};

    var serverUrl = params.url;
    if (serverUrl[serverUrl.length - 1] !== '/') {
        serverUrl += '/';
    }

    var doReq = function(method, path, parameters, body) {
        if (!parameters) {
            parameters = {};
        }
        parameters.key = params.api_key;
        parameters.api_token=params.api_token;
        parameters.full_report_score=params.full_report_score;

        console.log(serverUrl + path + encodeToURLQuery(parameters));
        var result = http(
            serverUrl + path + encodeToURLQuery(parameters),
            {
                Headers: {'Content-Type': ['application/json']},
                Method: method,
                Body: ''
            }
        );
        console.log(JSON.stringify(result));
        if (result.StatusCode < 200 && result.StatusCode > 299) {
            throw 'Failed to perform request ' + path + ', request status code: ' + result.StatusCode;
        }
        var obj = JSON.parse(result.Body);

        // analysis is not ready yet
        if (obj.error_code && obj.error_code == 106) {
            return {body: null, obj: {data:null}};
        }

        // no file matching hash
        if (obj.error_code && obj.error_code == 101) {
            return {body: null, obj: {data:null}};
        }
        if (obj.error_code) {
            throw 'Error code: ' + obj.error_code + ". Error: " + obj.error;
        }
        if (obj.success != 1) {
            throw 'Error code: ' + obj.error_code + ". Error: " + obj.error;
        }
        if (obj.data.errors) {
            throw 'Error: ' + obj.data.errors;
        }
        return {body: result.Body, obj: obj};
    }
    // var doFile = function (file_id) {
    //     var parameters;
    //     if (!parameters) {
    //         parameters = {};
    //     }
    //     parameters.key = params.api_key;
    //     parameters.api_token=params.api_token;
    //     var path = 'analysis/submit/file';

    //     var res = httpMultipart(
    //         serverUrl + path + encodeToURLQuery(parameters),
    //         file_id,
    //         {
    //             Method: 'POST',
    //             Headers: {'Content-Type': ['application/json']}
    //         }
    //         );
    //     console.log(JSON.stringify(res));
    //     if (res.StatusCode < 200 || res.StatusCode >= 300) {
    //         throw 'Failed to ' + queryName + ' , request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
    //     }
    //     return JSON.parse(res.Body);

    // }
    var analysisPoll = function(uuid,timeout,interval) {
        var res = doReq('POST', '/analysis/get', {uuid: uuid});

        var waited=0;
        while (!analysisReady(res.obj.data) && timeout>waited) {
            wait(interval);
            waited+=interval;
            res = doReq('POST', 'analysis/get', {uuid: uuid});
        }
        return res;
    }
    var analysisReady = function (data) {
        return (data && data.score);
    }
    var dataToMd = function(data) {
        var key = Object.keys(data.analysis_subject)[0];
        var name = data.analysis_subject[key];
        var md = '';
        md += '## Lastline analysis for ' + key + ': **' + name +'**\n';
        md += '### Score: ' + data.score + "\n";
        md += 'Task UUID: ' + data.task_uuid + "\n";
        md += 'Submission Time: ' + data.submission + "\n";
        if (Array.isArray(data.malicious_activity) && data.malicious_activity.length>0) {
            md += '### Suspicious Activity\n';
            md += objToMd(data.malicious_activity) + "\n";
        }
        md += "\n";
        return md;
    }
    // var submitFile = function (file,timeout) {
    //     file = {MD5: '47439da9cdcf7e6379e032334004dc11',
    //             SHA1: '48818704bca867afd66a5a4d01938ab65d1595c3',
    //             SHA256: '44403483a46def5191b998b2fd3de809130f100d41b59d57771ad2a9ec7dea52'};
    //     var res = doReq('POST','analysis/submit/file', {md5: file.MD5}); //, sha1: file.SHA1, sha256: file.SHA256});
    //     //var res = doFile(file_id);
    //     var md="";
    //     var ec={};

    //     return {Type: entryTypes.note, Contents: res.obj, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};
    // }
    var submitUrl = function (url,timeout,interval) {
        if (!timeout) {
            timeout = lastlineDefaults.timeout;
        }
        if (!interval) {
            interval = lastlineDefaults.interval;
        }

        var res = doReq('POST', 'analysis/submit/url', {url: url});
        var uuid = res.obj.data.task_uuid;

        var ec = {};
        var md = '';

        ec.lastlineTasks=[{'url':url,'uuid':uuid}];

        if (!analysisReady(res.obj.data) && timeout > 0) {
            res = analysisPoll(uuid,timeout,interval);
        }

        if (analysisReady(res.obj.data)) {
            md=dataToMd(res.obj.data);
            if (res.obj.data.score > params.malicious_score) {
                ec.URLMalicious={'url':url,'score':res.obj.data.score};
            }
        } else {
            md += '## Lastline analysis for url: **' + url +'**\n';
            md += 'URL submitted for analysis.\n';
            md += 'Task UUID: ' + uuid + '\n';
        }
        return {Type: entryTypes.note, Contents: res.obj, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};

    }
    var analysisGet = function(uuid,timeout,interval) {
        if (!timeout) {
            timeout = lastlineDefaults.timeout;
        }
        if (!interval) {
            interval = lastlineDefaults.interval;
        }
        if (!uuid || uuid == '') {
            throw 'No task UUID provided';
        }
        var ec = {};
        var md = '';

        res = analysisPoll(uuid,timeout,interval);

        if (analysisReady(res.obj.data)) {
            if (res.obj.data.score > params.malicious_score) {
                ec.URLMalicious={'url':url,'score':res.obj.data.score};
            }
            md+=dataToMd(res.obj.data);
        } else {
            md += 'Report not ready.\n';
            md += 'Task UUID: ' + uuid + '\n';
        }
        return {Type: entryTypes.note, Contents: res.obj, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};
    };

    // The command input arg holds the command sent from the user.
    switch (command) {
    // This is the call made when pressing the integration test button.
    case 'test-module':
        if (!parseInt(params.malicious_score) || parseInt(params.malicious_score) < 0 || parseInt(params.malicious_score > 100)) {
            throw 'Malicious score threshold invalid. Allowed values are 0-100.';
        }
        if (!parseInt(params.full_report_score) || parseInt(params.full_report_score) < 0 || parseInt(params.full_report_score > 100)) {
            throw 'Full report score threshold invalid. Allowed values are 0-100.';
        }
        submitUrl('google.com',0,10);
        return 'ok';
    case 'lastlineGet':
        return analysisGet(args.uuid, args.timeout, args.interval);
    case 'lastlineUrl':
        return submitUrl(args.url,args.timeout, args.interval);
    // case 'lastlineFile':
    //     return submitFile(args.file_id);
    default:
        // You can use args[argName] or args.argName to get a specific arg. args are strings.
        // You can use params[paramName] or params.paramName to get a specific params.
        // Params are of the type given in the integration page creation.
    }

  type: javascript
  commands:
  - name: lastlineGet
    deprecated: false
    arguments:
    - name: uuid
      required: true
      deprecated: false
      default: true
      description: Analysis report ID
    - name: timeout
      deprecated: false
      description: Timeout (in seconds) to wait for analysis to complete
    - name: interval
      deprecated: false
      description: Interval (in seconds) to poll for the analysis status
      defaultValue: "10"
    outputs:
    - contextPath: URLMalicious
      description: List of malicious URLs identified by Lastline analysis
    description: Get analysis report
  - name: lastlineUrl
    deprecated: false
    arguments:
    - name: url
      required: true
      deprecated: false
      default: true
      description: 'URL to be analyzed '
    - name: timeout
      deprecated: false
      description: Timeout (in seconds) to wait for analysis to complete
    - name: interval
      deprecated: false
      description: Interval (in seconds) to poll for the analysis status
      defaultValue: "10"
    outputs:
    - contextPath: lastlineTasks
      description: List of the submitted Lastline analysis tasks
    - contextPath: URLMalicious
      description: List of malicious URLs identified by Lastline analysis
      important: true
      importantDescription: List of malicious URLs identified by Lastline analysis
    description: Submit URL for analysis
  - name: lastlineFile
    deprecated: false
    arguments:
    - name: file_id
      required: true
      deprecated: false
      default: true
      description: File entry to be analyzed
    description: Submit a file for analysis
hidden: false
