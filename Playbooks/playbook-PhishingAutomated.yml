id: playbook5
version: -1
system: true
fromversion: 2.5.0
name: Phishing Playbook - Automated
description: |-
  This is an automated playbook to investigate suspected Phishing attempts.
  It picks up the required information from the incident metadata as created by the mail listener.
  Labels:
  - Email/from: Email address of the user targeted by the suspected phishing attempt, who reported the email by forwarding it
  - Email: the to recipients
  - Email/cc: the cc recipients
  - Email/format: the format of the email - text / html / etc.
  - Email/html: the html body
  - Email/text: the text body
  - Email/subject: subject of the email
  - Email/attachments: list of attachments
  - Email/headers: the headers for the email
tags:
- Phishing
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: ea4fb28a-8a76-4708-80c2-28f936d8bf94
    type: start
    task:
      id: ea4fb28a-8a76-4708-80c2-28f936d8bf94
      version: -1
      name: start_task
      issystemtask: true
      type: start
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "1"
    view: |-
      {
        "position": {
          "x": 930,
          "y": -111
        }
      }
  "1":
    id: "1"
    taskid: ea731eb3-f592-42f3-892a-6a7d48c42e4d
    type: title
    task:
      id: ea731eb3-f592-42f3-892a-6a7d48c42e4d
      version: -1
      name: Triage and Engage
      issystemtask: true
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "82"
    view: |-
      {
        "position": {
          "x": 930,
          "y": 40
        }
      }
  "4":
    id: "4"
    taskid: 70ba7f7d-290c-4fe5-8e6f-4e6dcd0293c9
    type: regular
    task:
      id: 70ba7f7d-290c-4fe5-8e6f-4e6dcd0293c9
      version: -1
      name: Auto-respond to acknowledge receipt
      description: Send an auto-response to the target telling them we are on it
      scriptName: SendEmail
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "77"
    scriptarguments:
      attachIDs: ""
      bcc: ""
      body: "Hi ${incident.labels.Email/from},\nWe've received your email and are
        investigating.\nPlease do not touch the email until further notice.\n\nCordially,
        \n  Your friendly neighborhood security team"
      cc: ""
      htmlBody: ""
      noteEntryID: ""
      subject: 'Re: Phishing Investigation - ${incident.name}'
      to: ${incident.labels.Email/from}
    view: |-
      {
        "position": {
          "x": 930,
          "y": 340
        }
      }
  "7":
    id: "7"
    taskid: f52cc4d4-43c4-45d2-850f-238b67c27b83
    type: regular
    task:
      id: f52cc4d4-43c4-45d2-850f-238b67c27b83
      version: -1
      name: Parse attached email and override context
      description: Parse email attachment identified in the previous step and override
        the email context values
      scriptName: ParseEmailFile
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "71"
    scriptarguments:
      entryid: ${EmailAttachment}
    results:
    - AttachmentName
    - Label/Email
    - Label/Email/cc
    - Label/Email/from
    - Label/Email/format
    - Label/Email/html
    - Label/Email/text
    - Label/Email/subject
    - Label/Email/attachments
    - Label/Email/headers
    view: |-
      {
        "position": {
          "x": 1337,
          "y": 881
        }
      }
  "9":
    id: "9"
    taskid: 205acc88-9a0d-4b9b-8e41-f6eb8a45f3ab
    type: condition
    task:
      id: 205acc88-9a0d-4b9b-8e41-f6eb8a45f3ab
      version: -1
      name: Does the email contain a textual body?
      scriptName: Exists
      issystemtask: true
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "72"
      "yes":
      - "10"
    scriptarguments:
      key: Label/Email/text
      value: ${incident.labels.Email/text}
    view: |-
      {
        "position": {
          "x": 1676.5,
          "y": 1185
        }
      }
  "10":
    id: "10"
    taskid: 7e22e45b-22c2-4b99-8e8a-23debfe52c0a
    type: regular
    task:
      id: 7e22e45b-22c2-4b99-8e8a-23debfe52c0a
      version: -1
      name: Extract IP Addresses from email body
      scriptName: ExtractIP
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "11"
    scriptarguments:
      text: ${incident.labels.Email/text}
    view: |-
      {
        "position": {
          "x": 1854.5,
          "y": 1385
        }
      }
  "11":
    id: "11"
    taskid: 1d46420f-dc6e-4913-8bea-b669a1f26841
    type: regular
    task:
      id: 1d46420f-dc6e-4913-8bea-b669a1f26841
      version: -1
      name: Extract URLs from email body
      scriptName: ExtractURL
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "72"
    scriptarguments:
      text: ${incident.labels.Email/text}
    view: |-
      {
        "position": {
          "x": 1854.5,
          "y": 1669
        }
      }
  "12":
    id: "12"
    taskid: 8f42f9c7-1126-48f6-87dd-240b4b2456af
    type: condition
    task:
      id: 8f42f9c7-1126-48f6-87dd-240b4b2456af
      version: -1
      name: Does the email contain an html body?
      scriptName: Exists
      issystemtask: true
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "72"
      "yes":
      - "13"
    scriptarguments:
      key: Label/Email/html
      value: ${incident.labels.Email/html}
    view: |-
      {
        "position": {
          "x": 930,
          "y": 1185
        }
      }
  "13":
    id: "13"
    taskid: 1b4dae74-ceff-446a-858c-9af723ddbebe
    type: regular
    task:
      id: 1b4dae74-ceff-446a-858c-9af723ddbebe
      version: -1
      name: Extract IP Addresses from email html body
      scriptName: ExtractIP
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "14"
    scriptarguments:
      text: ${incident.labels.Email/html}
    view: |-
      {
        "position": {
          "x": 655,
          "y": 1385
        }
      }
  "14":
    id: "14"
    taskid: 711bbd79-6ac0-4f8d-8e96-a3ec1edc801a
    type: regular
    task:
      id: 711bbd79-6ac0-4f8d-8e96-a3ec1edc801a
      version: -1
      name: Extract URLs from email html body
      scriptName: ExtractURL
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "72"
    scriptarguments:
      text: ${incident.labels.Email/html}
    view: |-
      {
        "position": {
          "x": 655,
          "y": 1669
        }
      }
  "15":
    id: "15"
    taskid: da130fbb-afd0-4ad3-8638-810422701be4
    type: condition
    task:
      id: da130fbb-afd0-4ad3-8638-810422701be4
      version: -1
      name: Have the email headers been provided?
      scriptName: Exists
      issystemtask: true
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "72"
      "yes":
      - "16"
    scriptarguments:
      key: Label/Email/headers
      value: ${incident.labels.Email/headers}
    view: |-
      {
        "position": {
          "x": 175,
          "y": 1185
        }
      }
  "16":
    id: "16"
    taskid: c9d578da-53cf-4309-8c8f-770e2838bb6d
    type: regular
    task:
      id: c9d578da-53cf-4309-8c8f-770e2838bb6d
      version: -1
      name: URLExtract from headers
      description: Extract URLs from the headers
      scriptName: ExtractURL
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "17"
    scriptarguments:
      text: ${incident.labels.Email/headers}
    view: |-
      {
        "position": {
          "x": -42,
          "y": 1385
        }
      }
  "17":
    id: "17"
    taskid: 7c94856f-ef22-4331-8a09-ab7b8e3451fa
    type: regular
    task:
      id: 7c94856f-ef22-4331-8a09-ab7b8e3451fa
      version: -1
      name: IPExtract from headers
      description: Extract URLs from the headers
      scriptName: ExtractIP
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "72"
    scriptarguments:
      text: ${incident.labels.Email/headers}
    view: |-
      {
        "position": {
          "x": -42,
          "y": 1669
        }
      }
  "22":
    id: "22"
    taskid: 4e3c9f39-a13d-494d-82b1-d624f3260892
    type: regular
    task:
      id: 4e3c9f39-a13d-494d-82b1-d624f3260892
      version: -1
      name: Detonate the file in a sandbox
      description: This task will use all the available sandboxes. It supports Cuckoo,
        Wildfire and FireEye.
      scriptName: SandboxDetonateFile
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "23"
    scriptarguments:
      entryID: ${File.EntryID(val!=val1---EmailAttachment)}
      interval: "30"
      timeout: "900"
    view: |-
      {
        "position": {
          "x": 695,
          "y": 2863
        }
      }
  "23":
    id: "23"
    taskid: c752c128-ee8f-4f94-877a-39bdb10a7d40
    type: condition
    task:
      id: c752c128-ee8f-4f94-877a-39bdb10a7d40
      version: -1
      name: Is the attachment malicious according to Sandbox report?
      issystemtask: true
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "28"
      "yes":
      - "42"
    scriptarguments:
      data: ${urls}
    view: |-
      {
        "position": {
          "x": 695,
          "y": 3011
        }
      }
  "28":
    id: "28"
    taskid: 4440a41f-7d53-4a52-86bb-85b49b6722b4
    type: title
    task:
      id: 4440a41f-7d53-4a52-86bb-85b49b6722b4
      version: -1
      name: 'Manual Investigation Step 1: Initial Inspection'
      issystemtask: true
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "30"
    view: |-
      {
        "position": {
          "x": 275,
          "y": 2946
        }
      }
  "30":
    id: "30"
    taskid: 61debf06-37d0-4ce0-875a-b6ca6c9bb44f
    type: condition
    task:
      id: 61debf06-37d0-4ce0-875a-b6ca6c9bb44f
      version: -1
      name: Check sender domain distance
      description: Check if the sender is trying to confuse the user with a domain
        that is very close to one of our own email domains
      scriptName: CheckSenderDomainDistance
      issystemtask: true
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "32"
      LevenshteinDistance:
      - "31"
    scriptarguments:
      distance: ""
      domain: company.com, companymail.com, companyeurope.com
      sender: ${incident.labels.Email/from}
    results:
    - LevenshteinDistance
    view: |-
      {
        "position": {
          "x": 275,
          "y": 3078
        }
      }
  "31":
    id: "31"
    taskid: 5778ac35-8936-4170-8cf6-8cc09c98a300
    type: regular
    task:
      id: 5778ac35-8936-4170-8cf6-8cc09c98a300
      version: -1
      name: Manually inspect the email for anything suspicious
      description: Since automatic triage did not find anything wrong, please inspect
        it manually and see if something stands out
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "32"
    view: |-
      {
        "position": {
          "x": 275,
          "y": 3300
        }
      }
  "32":
    id: "32"
    taskid: 5445acdd-df36-403e-8635-a0cbc3bd3f04
    type: regular
    task:
      id: 5445acdd-df36-403e-8635-a0cbc3bd3f04
      version: -1
      name: Assign and involve appropriate personnel
      description: 'Invite the relevant users for investigation - malware expert and
        network experts if needed. '
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    view: |-
      {
        "position": {
          "x": 275,
          "y": 3474
        }
      }
  "33":
    id: "33"
    taskid: e76cfd73-35f3-4065-8e59-c37e365cd06c
    type: regular
    task:
      id: e76cfd73-35f3-4065-8e59-c37e365cd06c
      version: -1
      name: Assess severity
      description: 'Based on the end user affected, and other information assess and
        change the severity if needed. '
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "34"
    view: |-
      {
        "position": {
          "x": 275,
          "y": 3711
        }
      }
  "34":
    id: "34"
    taskid: 3e30e515-bb4e-4b65-8d8c-a21a1e380126
    type: title
    task:
      id: 3e30e515-bb4e-4b65-8d8c-a21a1e380126
      version: -1
      name: 'Manual Investigation Step 2: Deeper Inspection'
      issystemtask: true
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "36"
    view: |-
      {
        "position": {
          "x": 275,
          "y": 3916
        }
      }
  "36":
    id: "36"
    taskid: cceb5cd4-a661-434d-87d8-24b9988877c4
    type: condition
    task:
      id: cceb5cd4-a661-434d-87d8-24b9988877c4
      version: -1
      name: Check if the hostname in urls is being misrepresented?
      description: |-
        See if the URL text versus the hostname shown are different by hovering
         over the link. Also carefully inspected the URL for spelling spoofing which
         is typically a sign of phishing email.
      issystemtask: true
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "37"
      "yes":
      - "42"
    view: |-
      {
        "position": {
          "x": 275,
          "y": 4079
        }
      }
  "37":
    id: "37"
    taskid: 2b253833-7a26-45a6-8683-5a65f318c3b1
    type: condition
    task:
      id: 2b253833-7a26-45a6-8683-5a65f318c3b1
      version: -1
      name: Is Pipl integration available?
      scriptName: IsIntegrationAvailable
      issystemtask: true
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "39"
      "yes":
      - "38"
    scriptarguments:
      brandname: pipl
    results:
    - brandInstances
    view: |-
      {
        "position": {
          "x": 129,
          "y": 4400
        }
      }
  "38":
    id: "38"
    taskid: 41e41e12-c3f7-4d92-8eb1-b0e598adca78
    type: regular
    task:
      id: 41e41e12-c3f7-4d92-8eb1-b0e598adca78
      version: -1
      name: Look up sender email address in Pipl
      script: pipl|||pipl-search
      issystemtask: true
      type: regular
      iscommand: true
      brand: pipl
    nexttasks:
      '#none#':
      - "39"
    scriptarguments:
      age: ""
      city: ""
      columns: ""
      country: ""
      email: ${incident.labels.Email/from}
      first-name: ""
      last-name: ""
      middle-name: ""
      phone: ""
      raw-address: ""
      raw-name: ""
      state: ""
      username: ""
      zipcode: ""
    view: |-
      {
        "position": {
          "x": -205,
          "y": 4563
        }
      }
  "39":
    id: "39"
    taskid: 5ec6d252-8985-44f8-84d8-8c038d0b3b80
    type: condition
    task:
      id: 5ec6d252-8985-44f8-84d8-8c038d0b3b80
      version: -1
      name: Is the sender name or email address identified as bad by threat feeds?
      description: 'Check the sender email and name against threat feed sources. '
      issystemtask: true
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "44"
      "yes":
      - "42"
    scriptarguments:
      key: responseRequired
      value: "yes"
    view: |-
      {
        "position": {
          "x": 129,
          "y": 4737
        }
      }
  "42":
    id: "42"
    taskid: 103b416e-75c9-4628-8b32-0dbab7b0f7a8
    type: title
    task:
      id: 103b416e-75c9-4628-8b32-0dbab7b0f7a8
      version: -1
      name: Response
      issystemtask: true
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "46"
    scriptarguments:
      key: responseRequired
      value: "yes"
    view: |-
      {
        "position": {
          "x": 1181,
          "y": 4903
        }
      }
  "44":
    id: "44"
    taskid: 0b1ba0a2-27cd-48f1-8e70-336942c43e64
    type: regular
    task:
      id: 0b1ba0a2-27cd-48f1-8e70-336942c43e64
      version: -1
      name: Send email to user notifying them this email is safe
      scriptName: SendEmail
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "45"
    scriptarguments:
      attachIDs: ""
      bcc: ""
      body: Hi ${originalFrom},\nWe've concluded that the email you forwarded to us
        is safe.\nThank you for your alertness and your participation in keeping our
        organization secure.\nCordially,\n  Your security team
      cc: ""
      htmlBody: ""
      subject: 'Re: Phishing Investigation - ${name}'
      to: ${originalFrom}
    view: |-
      {
        "position": {
          "x": 129,
          "y": 5080
        }
      }
  "45":
    id: "45"
    taskid: b93906e8-2d73-4f04-8c96-cf50eeaa2ec7
    type: regular
    task:
      id: b93906e8-2d73-4f04-8c96-cf50eeaa2ec7
      version: -1
      name: Close the phishing investigation
      scriptName: CloseInvestigation
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    scriptarguments:
      notes: Concluded that this email is safe and sent a response to user notifying
        them that they may proceed normally.
      reason: Safe
    view: |-
      {
        "position": {
          "x": 129,
          "y": 5313
        }
      }
  "46":
    id: "46"
    taskid: 2e583a63-f01a-4cc2-8aed-4872a41d6334
    type: regular
    task:
      id: 2e583a63-f01a-4cc2-8aed-4872a41d6334
      version: -1
      name: Send email to user notifying them it's a malicious email
      scriptName: SendEmail
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "47"
    scriptarguments:
      attachIDs: ""
      bcc: ""
      body: Hi ${originalFrom},\nWe've concluded that the email you forwarded to us
        is malicious. We've taken steps to blacklist the sender and quarantine the
        email. Good job on detecting and forwarding it to us!\nAll the best, Your
        security team
      cc: ""
      htmlBody: ""
      subject: 'Re: Phishing Investigation - ${name}'
      to: ${originalFrom}
    view: |-
      {
        "position": {
          "x": 1181,
          "y": 5080
        }
      }
  "47":
    id: "47"
    taskid: 08c684e8-65b9-4461-8eea-64991f25efef
    type: condition
    task:
      id: 08c684e8-65b9-4461-8eea-64991f25efef
      version: -1
      name: 'Is Mimecast integration available '
      scriptName: IsIntegrationAvailable
      issystemtask: true
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "48"
      "yes":
      - "49"
    scriptarguments:
      brandname: mimecast
    results:
    - brandInstances
    view: |-
      {
        "position": {
          "x": 1181,
          "y": 5313
        }
      }
  "48":
    id: "48"
    taskid: b97c18b9-ee11-4e6b-82cd-a730863ea41b
    type: regular
    task:
      id: b97c18b9-ee11-4e6b-82cd-a730863ea41b
      version: -1
      name: Get full list of all mailboxes from Exchange server
      scriptName: ADGetEmailForAllUsers
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "50"
    view: |-
      {
        "position": {
          "x": 1463,
          "y": 5498
        }
      }
  "49":
    id: "49"
    taskid: 1bf51a66-fe54-4473-8909-db3137b1dfa5
    type: regular
    task:
      id: 1bf51a66-fe54-4473-8909-db3137b1dfa5
      version: -1
      name: Find all mailboxes containing the malicious email using Mimecast
      scriptName: MimecastFindEmail
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "50"
    scriptarguments:
      active: ""
      attachmentText: ""
      attachmentType: ${incident.labels.Email/attachments}
      body: ""
      date: ""
      dateFrom: ""
      dateTo: ""
      dryRun: ""
      pageSize: ""
      queryXml: ""
      sentFrom: ${incident.labels.Email/from}
      sentTo: ""
      startRow: ""
      subject: ${incident.labels.Email/subject}
      text: ""
    view: |-
      {
        "position": {
          "x": 888,
          "y": 5498
        }
      }
  "50":
    id: "50"
    taskid: e88d41c2-b772-4d8b-849a-8fdafa84e275
    type: regular
    task:
      id: e88d41c2-b772-4d8b-849a-8fdafa84e275
      version: -1
      name: Search all mailboxes to find instances of the email
      scriptName: ExchangeSearch
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "51"
    scriptarguments:
      attachmentName: ${incident.labels.Email/attachments}
      body: ""
      mailbox: ${Mailboxes}
      sender: ${incident.labels.Email/from}
      subject: ${incident.labels.Email/subject}
    results:
    - ExchangeItemIDs
    view: |-
      {
        "position": {
          "x": 1181,
          "y": 5684
        }
      }
  "51":
    id: "51"
    taskid: 977c3554-a203-4b75-8341-3cfe787c2189
    type: condition
    task:
      id: 977c3554-a203-4b75-8341-3cfe787c2189
      version: -1
      name: Were any emails found on server?
      scriptName: Exists
      issystemtask: true
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "55"
      "yes":
      - "52"
    scriptarguments:
      key: ${ExchangeItemIDs}
      value: ${ExchangeItemIDs}
    view: |-
      {
        "position": {
          "x": 1181,
          "y": 5914
        }
      }
  "52":
    id: "52"
    taskid: 952c4981-c88c-475e-8ec3-5f4445256bb1
    type: condition
    task:
      id: 952c4981-c88c-475e-8ec3-5f4445256bb1
      version: -1
      name: Review found emails and decide whether to go ahead with automatic delete
      issystemtask: true
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "53"
      "yes":
      - "54"
    view: |-
      {
        "position": {
          "x": 695,
          "y": 6081
        }
      }
  "53":
    id: "53"
    taskid: 370383b4-f933-48fe-8a51-ed24db1b81fe
    type: regular
    task:
      id: 370383b4-f933-48fe-8a51-ed24db1b81fe
      version: -1
      name: Delete the emails from mailboxes manually
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "55"
    view: |-
      {
        "position": {
          "x": 930,
          "y": 6258
        }
      }
  "54":
    id: "54"
    taskid: e58b34a6-42f7-48ae-8560-55c9ef407079
    type: regular
    task:
      id: e58b34a6-42f7-48ae-8560-55c9ef407079
      version: -1
      name: Delete the instances of the email from Exchange server
      description: "Deleting the infected mails' IDs, useing EWS\nMail IDs are saved
        in context in \"ExchangeItemIDs\" "
      scriptName: ExchangeDeleteIDsFromContext
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "55"
    scriptarguments:
      attachmentName: ""
      mailbox: ${Users}
      sender: ""
      subject: ${Label/Email/subject}
    results:
    - ExchangeItemIDs
    view: |-
      {
        "position": {
          "x": 467,
          "y": 6258
        }
      }
  "55":
    id: "55"
    taskid: 015e68ff-2a6a-4c7f-86bc-bd52ef4516a9
    type: condition
    task:
      id: 015e68ff-2a6a-4c7f-86bc-bd52ef4516a9
      version: -1
      name: Did we find an attachment inside the email and extract its hash?
      scriptName: Exists
      issystemtask: true
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "yes":
      - "56"
    scriptarguments:
      key: AttachmentMD5
      value: ${AttachmentMD5}
    view: |-
      {
        "position": {
          "x": 1181,
          "y": 6512
        }
      }
  "56":
    id: "56"
    taskid: 748ff23d-6431-46bf-81e5-769ce4e4ac7d
    type: condition
    task:
      id: 748ff23d-6431-46bf-81e5-769ce4e4ac7d
      version: -1
      name: Is Carbon Black Protection (Bit9) Available?
      scriptName: IsIntegrationAvailable
      issystemtask: true
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "60"
      "yes":
      - "57"
    scriptarguments:
      brandname: carbonblackprotection
    results:
    - brandInstances
    view: |-
      {
        "position": {
          "x": 1181,
          "y": 6776
        }
      }
  "57":
    id: "57"
    taskid: 26fa11ee-26d9-4285-8b54-b4cc3af07498
    type: regular
    task:
      id: 26fa11ee-26d9-4285-8b54-b4cc3af07498
      version: -1
      name: Search attachment hash in the Bit9 file catalog
      scriptName: CBPCatalogFindHash
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "58"
    scriptarguments:
      md5: ${AttachmentMD5}
    view: |-
      {
        "position": {
          "x": 842,
          "y": 6946
        }
      }
  "58":
    id: "58"
    taskid: 48383ba8-94c2-4706-890e-500599ff88c9
    type: regular
    task:
      id: 48383ba8-94c2-4706-890e-500599ff88c9
      version: -1
      name: Check if the attachment hash is included in any Bit9 rules
      scriptName: CBPFindRule
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "59"
    scriptarguments:
      hash: ${AttachmentMD5}
    view: |-
      {
        "position": {
          "x": 842,
          "y": 7145
        }
      }
  "59":
    id: "59"
    taskid: fde5176a-66b8-4fb8-8147-f04d174e9c66
    type: regular
    task:
      id: fde5176a-66b8-4fb8-8147-f04d174e9c66
      version: -1
      name: Review Bit9 results
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "60"
    view: |-
      {
        "position": {
          "x": 842,
          "y": 7355
        }
      }
  "60":
    id: "60"
    taskid: 6a229223-43ef-4e76-8a7e-2b6003f5bbf0
    type: condition
    task:
      id: 6a229223-43ef-4e76-8a7e-2b6003f5bbf0
      version: -1
      name: Is Carbon Black Response available?
      scriptName: IsIntegrationAvailable
      issystemtask: true
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "64"
      "yes":
      - "61"
    scriptarguments:
      brandname: carbonblack
    results:
    - brandInstances
    view: |-
      {
        "position": {
          "x": 1181,
          "y": 7568
        }
      }
  "61":
    id: "61"
    taskid: 38ad4e5c-33d8-4fa8-834b-d1f556a567e0
    type: regular
    task:
      id: 38ad4e5c-33d8-4fa8-834b-d1f556a567e0
      version: -1
      name: Search attachments using Carbon Black
      scriptName: CBFindHash
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "62"
    scriptarguments:
      md5: ${AttachmentMD5}
    results:
    - found_file_locations
    view: |-
      {
        "position": {
          "x": 842,
          "y": 7736
        }
      }
  "62":
    id: "62"
    taskid: ef23d7ba-07ce-4264-8f38-5b0c300a0a7a
    type: condition
    task:
      id: ef23d7ba-07ce-4264-8f38-5b0c300a0a7a
      version: -1
      name: Did Carbon Black find the attachment on any endpoints?
      description: If someone saved or executed the malicious attachment, we need
        to investigate further
      scriptName: Exists
      issystemtask: true
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "64"
      "yes":
      - "63"
    scriptarguments:
      md5: ${AttachmentMD5}
      value: ${found_file_locations}
    view: |-
      {
        "position": {
          "x": 842,
          "y": 7981
        }
      }
  "63":
    id: "63"
    taskid: 7b2f5045-5c2e-4db3-895b-f3cd8d51ef20
    type: regular
    task:
      id: 7b2f5045-5c2e-4db3-895b-f3cd8d51ef20
      version: -1
      name: Investigate further
      description: Investigate the results of the execution
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "64"
    view: |-
      {
        "position": {
          "x": 550,
          "y": 8177
        }
      }
  "64":
    id: "64"
    taskid: 3aa9da87-5b96-4fd6-8c5a-89df2bd4de6c
    type: condition
    task:
      id: 3aa9da87-5b96-4fd6-8c5a-89df2bd4de6c
      version: -1
      name: Is CrowdStrike Falcon Host available?
      scriptName: IsIntegrationAvailable
      issystemtask: true
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "yes":
      - "65"
    scriptarguments:
      brandname: FalconHost
    results:
    - brandInstances
    view: |-
      {
        "position": {
          "x": 1181,
          "y": 8648
        }
      }
  "65":
    id: "65"
    taskid: 4fc02298-53a2-48bb-80bc-a83ae5532a52
    type: regular
    task:
      id: 4fc02298-53a2-48bb-80bc-a83ae5532a52
      version: -1
      name: Search for the attachment using CrowdStrike
      script: FalconHost|||cs-device-ran-on
      issystemtask: true
      type: regular
      iscommand: true
      brand: FalconHost
    nexttasks:
      '#none#':
      - "66"
    scriptarguments:
      type: md5
      value: ${AttachmentMD5}
    view: |-
      {
        "position": {
          "x": 1181,
          "y": 8925
        }
      }
  "66":
    id: "66"
    taskid: 7a76cb74-cf61-49e3-8862-ff4cb0292aec
    type: condition
    task:
      id: 7a76cb74-cf61-49e3-8862-ff4cb0292aec
      version: -1
      name: Did CrowdStrike locate the IOC on any devices?
      scriptName: Exists
      issystemtask: true
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "yes":
      - "67"
    scriptarguments:
      key: CSFoundDevices
      value: ${FalconHostDevices}
    view: |-
      {
        "position": {
          "x": 1181,
          "y": 9163
        }
      }
  "67":
    id: "67"
    taskid: 7b2f5045-5c2e-4db3-895b-f3cd8d51ef20
    type: regular
    task:
      id: 7b2f5045-5c2e-4db3-895b-f3cd8d51ef20
      version: -1
      name: Investigate further
      description: Investigate the results of the execution
      issystemtask: true
      type: regular
      iscommand: false
      brand: ""
    view: |-
      {
        "position": {
          "x": 1181,
          "y": 9422
        }
      }
  "71":
    id: "71"
    taskid: 75e0739e-4f37-4859-8ae2-857be0d57d6c
    type: title
    task:
      id: 75e0739e-4f37-4859-8ae2-857be0d57d6c
      version: -1
      name: Extract indicators
      issystemtask: true
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "9"
      - "12"
      - "15"
    view: |-
      {
        "position": {
          "x": 930,
          "y": 1040
        }
      }
  "72":
    id: "72"
    taskid: 03606952-f504-44b2-8371-5a548e395048
    type: title
    task:
      id: 03606952-f504-44b2-8371-5a548e395048
      version: -1
      name: Check indicators
      issystemtask: true
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "78"
      - "79"
      - "80"
    view: |-
      {
        "position": {
          "x": 930,
          "y": 1963
        }
      }
  "73":
    id: "73"
    taskid: f2d9e172-91b2-4de3-8a29-71c78a92d550
    type: regular
    task:
      id: f2d9e172-91b2-4de3-8a29-71c78a92d550
      version: -1
      name: Add email attachment to context
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "7"
    scriptarguments:
      key: EmailAttachment
      value: ${reportedemailentryid}
    view: |-
      {
        "position": {
          "x": 1337,
          "y": 722
        }
      }
  "74":
    id: "74"
    taskid: 56e3491b-7b0b-434a-834d-42360f299a2b
    type: regular
    task:
      id: 56e3491b-7b0b-434a-834d-42360f299a2b
      version: -1
      name: Check URL's
      scriptName: URLReputation
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "81"
    scriptarguments:
      url: ${URL}
    view: |-
      {
        "position": {
          "x": -52,
          "y": 2283
        }
      }
  "75":
    id: "75"
    taskid: b8a9c31b-9cba-4e2d-897c-323accf28049
    type: regular
    task:
      id: b8a9c31b-9cba-4e2d-897c-323accf28049
      version: -1
      name: Check IP's
      scriptName: IPReputation
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "81"
    scriptarguments:
      ip: ${IP.Address}
      url: ${IP}
    continueonerror: true
    view: |-
      {
        "position": {
          "x": 1854.5,
          "y": 2283
        }
      }
  "76":
    id: "76"
    taskid: eafe154a-f0b2-4fa1-8174-b7740911ec3b
    type: regular
    task:
      id: eafe154a-f0b2-4fa1-8174-b7740911ec3b
      version: -1
      name: Check Files
      scriptName: FileReputation
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "81"
    scriptarguments:
      file: ${File.MD5}
      url: ${File}
    view: |-
      {
        "position": {
          "x": 930,
          "y": 2283
        }
      }
  "77":
    id: "77"
    taskid: ce27906a-2475-4014-8c05-611f430a6f9e
    type: condition
    task:
      id: ce27906a-2475-4014-8c05-611f430a6f9e
      version: -1
      name: Do we have an email attachment?
      scriptName: IdentifyAttachedEmail
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "71"
      "yes":
      - "73"
    results:
    - reportedemailentryid
    view: |-
      {
        "position": {
          "x": 930,
          "y": 510
        }
      }
  "78":
    id: "78"
    taskid: 080a6c86-a12a-4a87-8b5a-c85c7415925f
    type: condition
    task:
      id: 080a6c86-a12a-4a87-8b5a-c85c7415925f
      version: -1
      name: Did we find any URL's to check?
      description: Check if we have known bad URLs
      scriptName: Exists
      issystemtask: true
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "81"
      "yes":
      - "74"
    scriptarguments:
      data: ${urls}
      value: ${URL}
    view: |-
      {
        "position": {
          "x": -52,
          "y": 2103
        }
      }
  "79":
    id: "79"
    taskid: 602f1e44-3918-490b-8a39-e699b5c49932
    type: condition
    task:
      id: 602f1e44-3918-490b-8a39-e699b5c49932
      version: -1
      name: Did we find any Files to check?
      description: Check if we have known bad URLs
      scriptName: Exists
      issystemtask: true
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "81"
      "yes":
      - "76"
    scriptarguments:
      data: ${urls}
      value: ${File}
    view: |-
      {
        "position": {
          "x": 930,
          "y": 2103
        }
      }
  "80":
    id: "80"
    taskid: 07ecd6af-a3f1-4efe-83a7-d8d54880a0da
    type: condition
    task:
      id: 07ecd6af-a3f1-4efe-83a7-d8d54880a0da
      version: -1
      name: Did we find any IP's to check?
      description: Check if we have known bad URLs
      scriptName: Exists
      issystemtask: true
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "81"
      "yes":
      - "75"
    scriptarguments:
      data: ${urls}
      value: ${IP}
    view: |-
      {
        "position": {
          "x": 1854.5,
          "y": 2103
        }
      }
  "81":
    id: "81"
    taskid: 5359d876-c7b6-495c-8249-fd87d30d5663
    type: condition
    task:
      id: 5359d876-c7b6-495c-8249-fd87d30d5663
      version: -1
      name: Was any malicious indicator found?
      scriptName: IsMaliciousIndicatorFound
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "83"
      "yes":
      - "42"
    view: |-
      {
        "position": {
          "x": 930,
          "y": 2463
        }
      }
  "82":
    id: "82"
    taskid: f8a8784d-2df0-4b10-8436-114f6a2c10a5
    type: regular
    task:
      id: f8a8784d-2df0-4b10-8436-114f6a2c10a5
      version: -1
      name: Store the reporting person's email address for later replies
      description: Save the original "from" sender because it might be overridden
        by eml/msg attachments
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "4"
    scriptarguments:
      key: originalFrom
      value: ${incident.labels.Email/from}
    view: |-
      {
        "position": {
          "x": 930,
          "y": 168
        }
      }
  "83":
    id: "83"
    taskid: 166201cb-cab1-4d3e-82b9-4389aa1b1031
    type: condition
    task:
      id: 166201cb-cab1-4d3e-82b9-4389aa1b1031
      version: -1
      name: Is there any file found in this investigation?
      scriptName: Exists
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "28"
      "yes":
      - "84"
    scriptarguments:
      value: ${File.EntryID}
    view: |-
      {
        "position": {
          "x": 275,
          "y": 2558
        }
      }
  "84":
    id: "84"
    taskid: b246b78b-af64-44c0-8ca2-f3e137f44794
    type: condition
    task:
      id: b246b78b-af64-44c0-8ca2-f3e137f44794
      version: -1
      name: 'Is there any file found in this investigation which is not attachment? '
      scriptName: Exists
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "28"
      "yes":
      - "22"
    scriptarguments:
      value: ${File.EntryID(val!=val1---EmailAttachment)}
    view: |-
      {
        "position": {
          "x": 695,
          "y": 2653
        }
      }
view: |-
  {
    "linkLabelsPosition": {
      "12_72_#default#": 0.36,
      "15_72_#default#": 0.17,
      "23_28_#default#": 0.81,
      "23_42_yes": 0.1,
      "36_42_yes": 0.11,
      "39_42_yes": 0.17,
      "51_52_yes": 0.73,
      "60_64_#default#": 0.85,
      "62_64_#default#": 0.46,
      "78_81_no": 0.9,
      "83_28_no": 0.46,
      "84_22_yes": 0.61,
      "84_28_no": 0.67,
      "9_72_#default#": 0.26
    },
    "paper": {
      "dimensions": {
        "height": 9628,
        "width": 2439.5,
        "x": -205,
        "y": -111
      }
    }
  }
