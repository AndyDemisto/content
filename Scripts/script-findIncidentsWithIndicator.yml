commonfields:
  id: findIncidentsWithIndicator
  version: -1 
name: findIncidentsWithIndicator
script: |-
  var res = executeCommand("getIncidents", {"query": "indicator.value:"+args.indicator});
  var incidentsIDs=[];
  var ec = {};
  var md="#### Finding incidents with indicator: *" + args.indicator + "*\n";
  if (res[0].Contents.data) {
      var incidents = res[0].Contents.data;
      for (var i=0;i<incidents.length;i++) {
          if (!args.currentIncidentId || (args.currentIncidentId && args.currentIncidentId != incidents[i].id)) {
              incidentsIDs.push(incidents[i].id)
          }
      }
      md += "Found incidents IDs: " + incidentsIDs;
      ec = {"IncidentsWithIndicatoer":[{"Indicator:": args.indicator,"incidentIDs":incidentsIDs}]};
  } else {
      md += "No incidents found"
  }
  return {Type: entryTypes.note, Contents: res, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};
type: javascript
tags:
- Utility
comment: Lookup incidents with specified indicator. Use currentIncidentId to omit
  the existing incident from output
enabled: true
args:
- name: indicator
  required: true
  default: true
  description: Indicator to search for
- name: currentIncidentId
  description: Current incident ID to be ignored
outputs:
- contextPath: IncidentsWithIndicatoer.Indicator
  description: Indicator that was found in other incidents
- contextPath: IncidentsWithIndicatoer.Indicator.IncidentIDs 
  description: Incident IDs that the indicator was found in
scripttarget: 0
