commonfields:
  id: EmailAskUser
  version: -1
name: EmailAskUser
script: |-
  #### email body type
  if (demisto.args()['bodyType'] and demisto.args()['bodyType']=='html'):
      bodyType = 'html'
  else:
      bodyType = 'text'

  #### Get entitlement
  res = demisto.executeCommand('addOneTimeEntitlement', {})
  if isError(res[0]):
      demisto.results(res)
      sys.exit(0)
  entitlement = demisto.get(res[0], 'Contents')

  #### Handle options
  option1 = demisto.get(demisto.args(), 'option1')
  if not option1:
      option1 = 'yes'
  option2 = demisto.get(demisto.args(), 'option2')
  if not option2:
      option2 = 'no'

  #### Create email subject
  subjectSuffix = ' - #' + demisto.investigation()['id'] + ' ' + entitlement
  if demisto.get(demisto.args(), 'task'):
      subjectSuffix += ' #' + demisto.get(demisto.args(), 'task')

  #### Create email body
  if (bodyType == 'html'):
      message = '%s<br/><br/>Please reply with either %s or %s' % (demisto.args()['message'], option1, option2)
  else:
      message = '%s\n\nPlease reply with either %s or %s' % (demisto.args()['message'].replace('\\n', '\n'), option1, option2)

  #### Get email recipients
  roles = demisto.get(demisto.args(), 'roles')
  addresses = []
  if roles is not None:
            usersRes = demisto.executeCommand('getUsers', { "roles": roles });
            emails =  map(lambda x: x["email"], usersRes[0]["Contents"])
            addresses.extend(emails)
  argMail = demisto.get(demisto.args(), 'email')
  if argMail is not None:
      addresses.extend([argMail])

  if len(addresses) > 0:
      #### prepare args and run send-mail
      adStr = ",".join(addresses)
      args = demisto.args()
      args['to'] = adStr
      args['subject'] = demisto.get(demisto.args(), 'subject') + subjectSuffix
      args['body'] = message
      if (bodyType == 'html'):
          args['htmlBody'] = message
      else:
          args['body'] = message

      attachIds = demisto.get(demisto.args(),'attachIds')
      if attachIds is not None:
          args['attachIDs'] = attachIds
      demisto.results(demisto.executeCommand('send-mail', args))
  else:
      demisto.results({ 'Type' : entryTypes['error'], 'ContentsFormat' : formats['text'], 'Contents' : 'No email address found' })
type: python
tags:
- email
comment: Ask a user a question via email and process the reply directly into the investigation.
enabled: true
args:
- name: email
  default: true
  description: The email of the user to ask
- name: subject
  required: true
  description: The subject for the email
- name: message
  required: true
  description: The message to the user to ask
- name: option1
  description: First option for a user reply. "yes" is the default.
- name: option2
  description: Second option for the user reply. "no" is the default.
- name: task
  description: Which task should we close with the reply. If none then no playbook
    tasks will be closed.
- name: roles
  description: Send mail to all users of these roles (csv list)
- name: attachIds
  description: Attachments
- name: bodyType
  auto: PREDEFINED
  predefined:
  - "text"
  - "html"
  defaultValue: "text"
  description: Type of email body to send - text ot HTML
scripttarget: 0
releaseNotes: added capability to send HTML emails, and attachements
