commonfields:
  id: ADGetEmailForAllUsers
  version: -1
name: ADGetEmailForAllUsers
script: |
  mails = []
  MAIL_CONTEXT_KEY = "Mailboxes"

  attrs = 'mail'
  filterstr = r"(&(objectClass=User))"
  resp = demisto.executeCommand( 'ad-search' , { 'filter' : filterstr, 'attributes' : attrs } )
  if isError(resp[0]):
      demisto.results(resp)
  else:
      data = demisto.get(resp[0], "Contents")
      for item in data:
          mails += [item["mail"]] if item["mail"] else []

      demisto.setContext(MAIL_CONTEXT_KEY, ",".join(mails))

      demisto.results('yes')
type: python
tags:
- active directory
- Condition
comment: Use Active Directory to retrieve the email address associated with tall users.
system: true
scripttarget: 0
dependson:
  must:
  - ad-search
timeout: 0s
outputs:
- contextPath: yes
  description: if managed to get all users mailboxes
- contextPath: no
  description: if did not managed to get all users mailboxes
- contextPath: Mailboxes
  description: List of all users mailbox addresses
  important: true
  importantDescription: List of Active Directory endpoints

